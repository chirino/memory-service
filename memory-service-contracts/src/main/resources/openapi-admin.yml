openapi: 3.1.0
info:
  title: Memory Service Admin API
  version: v1
  description: |-
    Admin APIs for Memory Service. These endpoints provide administrative access
    to all conversations across all users, including soft-deleted resources.
    Access requires admin or auditor role.
tags:
  - name: Admin
    description: Administrative APIs for system-wide access to conversations and entries.
  - name: System
    description: Health Endpoints
paths:

  ############################################################
  # System
  ############################################################

  /v1/health:
    get:
      tags: [System]
      summary: Health check
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        default:
          $ref: '#/components/responses/Error'

  /v1/admin/conversations:
    get:
      tags: [Admin]
      summary: List all conversations (admin/auditor)
      description: |-
        Lists conversations across all users. Supports filtering by userId,
        deleted status, and date ranges. Requires auditor or admin role.
      operationId: adminListConversations
      parameters:
        - name: userId
          in: query
          required: false
          description: Filter conversations owned by this user.
          schema:
            type: string
        - name: includeDeleted
          in: query
          required: false
          description: Include soft-deleted conversations in results.
          schema:
            type: boolean
            default: false
        - name: onlyDeleted
          in: query
          required: false
          description: Show only soft-deleted conversations.
          schema:
            type: boolean
            default: false
        - name: deletedAfter
          in: query
          required: false
          description: "Filter: deleted at or after this time (ISO 8601)."
          schema:
            type: string
            format: date-time
        - name: deletedBefore
          in: query
          required: false
          description: "Filter: deleted before this time (ISO 8601)."
          schema:
            type: string
            format: date-time
        - name: after
          in: query
          required: false
          description: Cursor for pagination.
          schema:
            type: string
        - name: limit
          in: query
          required: false
          description: Maximum number of conversations to return.
          schema:
            type: integer
            default: 100
        - name: justification
          in: query
          required: false
          description: Reason for this admin action (for audit log).
          schema:
            type: string
      responses:
        '200':
          description: A list of conversations.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AdminConversationSummary'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/conversations/{id}:
    get:
      tags: [Admin]
      summary: Get any conversation (admin/auditor)
      description: |-
        Retrieves a conversation by ID, including soft-deleted conversations
        if includeDeleted=true. Requires auditor or admin role.
      operationId: adminGetConversation
      parameters:
        - name: id
          in: path
          required: true
          description: Conversation identifier.
          schema:
            type: string
        - name: includeDeleted
          in: query
          required: false
          description: Include soft-deleted conversations.
          schema:
            type: boolean
            default: false
        - name: justification
          in: query
          required: false
          description: Reason for this admin action (for audit log).
          schema:
            type: string
      responses:
        '200':
          description: The conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminConversation'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    delete:
      tags: [Admin]
      summary: Soft-delete any conversation (admin only)
      description: |-
        Soft-deletes a conversation. Requires admin role.
        
        **Deleting a conversation deletes all conversations in the same fork tree** (the root conversation and all its forks). Memberships and entries associated with these conversations are also deleted.
      operationId: adminDeleteConversation
      parameters:
        - name: id
          in: path
          required: true
          description: Conversation identifier.
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminActionRequest'
      responses:
        '204':
          description: Conversation deleted.
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/conversations/{id}/restore:
    post:
      tags: [Admin]
      summary: Restore a soft-deleted conversation (admin only)
      description: |-
        Restores a soft-deleted conversation. Requires admin role.
      operationId: adminRestoreConversation
      parameters:
        - name: id
          in: path
          required: true
          description: Conversation identifier.
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminActionRequest'
      responses:
        '200':
          description: Conversation restored.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminConversation'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conversation is not deleted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/conversations/{id}/entries:
    get:
      tags: [Admin]
      summary: Get entries from any conversation (admin/auditor)
      description: |-
        Retrieves entries from a conversation, including soft-deleted
        conversations if includeDeleted=true. Requires auditor or admin role.
      operationId: adminGetEntries
      parameters:
        - name: id
          in: path
          required: true
          description: Conversation identifier.
          schema:
            type: string
        - name: after
          in: query
          required: false
          description: Cursor for pagination.
          schema:
            type: string
        - name: limit
          in: query
          required: false
          description: Maximum number of entries to return.
          schema:
            type: integer
            default: 50
        - name: channel
          in: query
          required: false
          description: Filter by entry channel.
          schema:
            $ref: '#/components/schemas/Channel'
        - name: includeDeleted
          in: query
          required: false
          description: Include entries from soft-deleted conversations.
          schema:
            type: boolean
            default: false
        - name: justification
          in: query
          required: false
          description: Reason for this admin action (for audit log).
          schema:
            type: string
      responses:
        '200':
          description: Entries.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Entry'
                  nextCursor:
                    type: string
                    nullable: true
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/conversations/{id}/memberships:
    get:
      tags: [Admin]
      summary: Get memberships for any conversation (admin/auditor)
      description: |-
        Retrieves memberships for a conversation. Requires auditor or admin role.
      operationId: adminGetMemberships
      parameters:
        - name: id
          in: path
          required: true
          description: Conversation identifier.
          schema:
            type: string
        - name: includeDeleted
          in: query
          required: false
          description: Include memberships from soft-deleted conversations.
          schema:
            type: boolean
            default: false
        - name: justification
          in: query
          required: false
          description: Reason for this admin action (for audit log).
          schema:
            type: string
      responses:
        '200':
          description: Memberships.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/conversations/search:
    post:
      tags: [Admin]
      summary: System-wide semantic search (admin/auditor)
      description: |-
        Performs semantic search across all conversations, optionally filtered
        by userId. Requires auditor or admin role.
      operationId: adminSearchConversations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminSearchEntriesRequest'
      parameters:
        - name: justification
          in: query
          required: false
          description: Reason for this admin action (for audit log).
          schema:
            type: string
      responses:
        '200':
          description: Search results.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchResult'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/evict:
    post:
      tags: [Admin]
      summary: Hard-delete soft-deleted resources past retention period
      description: |-
        Permanently removes resources that have been soft-deleted for longer than
        the specified retention period. This operation is irreversible.

        The operation runs in batches to minimize database lock contention.

        **Execution modes:**
        - **Synchronous** (default): Blocks until eviction completes.
        - **Async** (`?async=true`): Returns immediately with a job ID. Poll `/v1/admin/evict/jobs/{jobId}` for status.

        **Response modes (based on Accept header, synchronous only):**
        - `Accept: application/json` (default): Returns 204 No Content when complete.
        - `Accept: text/event-stream`: Streams progress updates as SSE events.

        Requires admin role.
      operationId: adminEvict
      parameters:
        - name: async
          in: query
          required: false
          description: Run eviction asynchronously and return a job ID.
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EvictRequest'
      responses:
        '200':
          description: |-
            SSE progress stream (when Accept: text/event-stream).
            Each event contains {"progress": N} where N is 0-100.
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-Sent Events stream with progress updates.
              example: |
                data: {"progress": 0}

                data: {"progress": 50}

                data: {"progress": 100}
        '202':
          description: Async eviction job started (when async=true).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvictionJobResponse'
        '204':
          description: Eviction completed successfully (default synchronous response).
        '400':
          description: Invalid request (bad retention period format, unknown resource type).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/admin/evict/jobs/{jobId}:
    get:
      tags: [Admin]
      summary: Get eviction job status
      description: |-
        Returns the current status and progress of an async eviction job.

        Jobs are kept in memory for 1 hour after completion.

        Requires admin role.
      operationId: adminGetEvictionJobStatus
      parameters:
        - name: jobId
          in: path
          required: true
          description: The job ID returned from an async eviction request.
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Job status.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvictionJobResponse'
        '404':
          description: Job not found (may have expired or never existed).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    Error:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
          additionalProperties: true

    AccessLevel:
      type: string
      description: Access level of a user for a conversation.
      enum:
        - owner
        - manager
        - writer
        - reader

    AdminConversationSummary:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
          nullable: true
        ownerUserId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        deletedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the conversation was soft-deleted.
        lastMessagePreview:
          type: string
          nullable: true
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'

    AdminConversation:
      allOf:
        - $ref: '#/components/schemas/AdminConversationSummary'
        - type: object
          properties:
            forkedAtEntryId:
              type: string
              nullable: true
            forkedAtConversationId:
              type: string
              nullable: true

    AdminActionRequest:
      type: object
      properties:
        justification:
          type: string
          description: Reason for the admin action (for audit log).
      example:
        justification: "User requested account cleanup per support ticket #1234"

    Channel:
      type: string
      description: Logical channel of the entry within the conversation.
      enum:
        - history
        - memory
        - summary

    Entry:
      type: object
      required:
        - id
        - conversationId
        - channel
        - contentType
        - content
        - createdAt
      properties:
        id:
          type: string
        conversationId:
          type: string
        userId:
          type: string
          nullable: true
        channel:
          $ref: '#/components/schemas/Channel'
        epoch:
          type: integer
          format: int64
          nullable: true
        contentType:
          type: string
          description: |-
            Describes the schema/format of the content array.
            Examples: "message", "LC4J", "SpringAI"
        content:
          type: array
          items: {}
        createdAt:
          type: string
          format: date-time

    ConversationMembership:
      type: object
      properties:
        conversationId:
          type: string
        userId:
          type: string
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
        createdAt:
          type: string
          format: date-time

    AdminSearchEntriesRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Natural language query.
        topK:
          type: integer
          default: 20
        conversationIds:
          type: array
          items:
            type: string
          nullable: true
        userId:
          type: string
          nullable: true
          description: Filter search to conversations owned by this user.
        before:
          type: string
          nullable: true
        includeDeleted:
          type: boolean
          default: false
          description: Include entries from soft-deleted conversations.

    SearchResult:
      type: object
      properties:
        entry:
          $ref: '#/components/schemas/Entry'
        score:
          type: number
          format: float
        highlights:
          type: string
          nullable: true

    EvictRequest:
      type: object
      required:
        - retentionPeriod
        - resourceTypes
      properties:
        retentionPeriod:
          type: string
          description: |-
            ISO 8601 duration. Resources soft-deleted longer than this are hard-deleted.
            Examples: P90D (90 days), P1Y (1 year), PT24H (24 hours).
          example: "P90D"
        resourceTypes:
          type: array
          items:
            type: string
            enum:
              - conversation_groups
              - conversation_memberships
          description: Which resource types to evict.
          example: ["conversation_groups"]
        justification:
          type: string
          description: Reason for the eviction (for audit log).
          example: "Quarterly data cleanup per retention policy"

    EvictProgressEvent:
      type: object
      properties:
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Percentage of eviction completed (0-100).
          example: 55

    EvictionJobResponse:
      type: object
      required:
        - jobId
        - status
        - progress
        - createdAt
      properties:
        jobId:
          type: string
          format: uuid
          description: Unique identifier for the eviction job.
        status:
          type: string
          enum:
            - PENDING
            - RUNNING
            - COMPLETED
            - FAILED
          description: Current status of the eviction job.
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Percentage of eviction completed (0-100).
        createdAt:
          type: string
          format: date-time
          description: When the job was created.
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: When the job completed (null if still running).
        error:
          type: string
          nullable: true
          description: Error message if the job failed.
