openapi: 3.1.0
info:
  title: Memory Service API
  version: v1
  description: |-
    Memory Service for AI agents.

    The service stores all entries exchanged between agents, users, and
    other actors, supports replay and forking of conversations, and exposes
    user-facing and agent-facing APIs. Conversation access is controlled by
    per-user permissions (owner, manager, writer, reader).
tags:
  - name: Conversations
    description: APIs for listing, reading, writing, and sharing conversations (user and agent views).
  - name: Search
    description: Semantic and keyword search APIs.
  - name: Sharing
    description: APIs for managing conversation ownership and sharing.
paths:

  ############################################################
  # Conversations
  ############################################################

  /v1/conversations:
    get:
      tags: [Conversations]
      summary: List conversations visible to current user
      description: |-
        Lists all conversations the current user has access to (owner, manager, writer, or reader).
      operationId: listConversations
      parameters:
        - name: mode
          in: query
          required: false
          description: |-
            Listing mode for conversations.
            - `all`: include all conversations the user can access (roots and forks).
            - `roots`: only include root conversations.
            - `latest-fork`: include the most recently updated conversation per root tree.
          schema:
            type: string
            enum: [all, roots, latest-fork]
            default: all
        - name: after
          in: query
          required: false
          description: Cursor for pagination; returns items after this conversation id.
          schema:
            type: string
            nullable: true
        - name: limit
          in: query
          required: false
          description: Maximum number of conversations to return.
          schema:
            type: integer
            default: 20
        - name: query
          in: query
          required: false
          description: Optional text query for basic title/metadata search.
          schema:
            type: string
            nullable: true
      responses:
        '200':
          description: A list of conversations.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationSummary'
                  nextCursor:
                    type: string
                    nullable: true
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Conversations]
      summary: Create a conversation
      description: |-
        Creates a new conversation owned by the current user.
      operationId: createConversation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: The created conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}:
    get:
      tags: [Conversations]
      summary: Get a conversation
      description: Retrieve a conversation the user has access to.
      operationId: getConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier.
          schema:
            type: string
      responses:
        '200':
          description: The conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    delete:
      tags: [Conversations]
      summary: Delete a conversation
      description: |-
        Deletes a conversation. Only the owner (or manager, depending on policy) may delete.
        
        **Deleting a conversation deletes all conversations in the same fork tree** (the root conversation and all its forks). Memberships and messages associated with these conversations are also deleted.
      operationId: deleteConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Conversation deleted.
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/entries:
    get:
      tags: [Conversations]
      summary: List conversation entries
      description: |-
        Returns entries in a conversation, ordered by creation time.

        The `channel` parameter determines which logical channel of entries
        is returned:

        - `history` (default) returns the user-visible conversation between
          users and the agent.
        - `memory` returns agent memory entries which are typically not
          shown directly to end users. Memory entries are scoped to the
          calling client id derived from the API key.
      operationId: listConversationEntries
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
        - name: after
          in: query
          required: false
          description: Cursor for pagination; returns entries after this entry id.
          schema:
            type: string
            nullable: true
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
        - name: channel
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/Channel'
            default: history
          description: |-
            Channel of entries to return. Defaults to `history` for the
            user-visible conversation; `memory` returns agent memory entries
            scoped to the calling client id.
        - name: epoch
          in: query
          required: false
          schema:
            type: string
            nullable: true
            default: latest
          description: |-
            Optional epoch filter when listing the `memory` channel. Valid values
            are `latest`, `all`, or a numeric epoch identifier. Defaults to
            `latest` when not provided. The epoch selection is scoped to the
            calling client id.
      responses:
        '200':
          description: A list of entries.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Entry'
                  nextCursor:
                    type: string
                    nullable: true
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Conversations]
      summary: Append an entry
      description: |-
        Appends a new entry to the conversation.

        This endpoint is used by both end-user clients and agents.
        The service determines whether the caller is a user or an agent
        based on authentication (for example, API keys or tokens) and
        stores the entry with the appropriate internal role and visibility.
      operationId: appendConversationEntry
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEntryRequest'
      responses:
        '201':
          description: The created entry.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Entry'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/entries/sync:
    post:
      tags: [Conversations]
      summary: Synchronize the agent memory epoch
      description: |-
        Synchronizes the in-memory context for the conversation. The service fails
        when any entry is not targeting the `memory` channel, then compares the
        provided list to the entries already stored in the latest memory epoch.
        If there is no difference it is a no-op, if the list merely appends more
        entries they are added to the current epoch, otherwise a new epoch is
        created and all provided entries are stored under the new epoch. Memory
        sync is scoped to the calling client id (from the API key). Requires a
        valid agent API key.
      operationId: syncConversationMemory
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncEntriesRequest'
      responses:
        '200':
          description: Result of the sync operation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncEntriesResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/entries/{entryId}/fork:
    post:
      tags: [Conversations]
      summary: Fork a conversation at a given user entry
      description: |-
        Creates a new conversation that replays history up to just before the selected
        user entry and then diverges starting at that point.

        The fork point must be an existing user-authored entry; in the new forked
        conversation that original entry is not present and the next user entry
        is supplied by the caller in a follow-up request.
      operationId: forkConversationAtEntry
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
        - name: entryId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForkFromEntryRequest'
      responses:
        '201':
          description: The newly created forked conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/forks:
    get:
      tags: [Conversations]
      summary: List forks for a conversation
      description: |-
        Returns all forked conversations that share the same root conversation as the
        given conversation. Each fork entry includes the message id at which it forked
        and the timestamp when the forked conversation was created.

        This is intended for UIs that want to fetch all fork points once per conversation
        and then decide how to render branch navigation (e.g., which is the oldest fork).
      operationId: listConversationForks
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Forked conversations related to this conversation's root.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationForkSummary'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Conversations]
      summary: Share conversation with another user
      description: |-
        Grants another user access to the conversation with the specified access level.
      operationId: shareConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShareConversationRequest'
      responses:
        '201':
          description: Created membership.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/cancel-response:
    post:
      tags: [Conversations]
      summary: Cancel an in-progress response
      description: |-
        Requests cancellation of an in-progress response stream for the conversation.
        Requires WRITER access and an authenticated user session.
      operationId: cancelConversationResponse
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cancel request accepted.
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Error'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  ############################################################
  # Sharing
  ############################################################
  /v1/conversations/{conversationId}/transfer-ownership:
    post:
      tags: [Sharing]
      summary: Request ownership transfer
      description: |-
        Initiates a transfer of conversation ownership to another user. The other
        user must accept the transfer via a separate API or out-of-band process.
      operationId: transferConversationOwnership
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newOwnerUserId
              properties:
                newOwnerUserId:
                  type: string
      responses:
        '202':
          description: Ownership transfer requested.
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/memberships:
    get:
      tags: [Sharing]
      summary: List conversation memberships
      description: |-
        Lists all users that have access to the conversation and their access levels.
      operationId: listConversationMemberships
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Memberships for the conversation.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []


  /v1/conversations/{conversationId}/memberships/{userId}:
    patch:
      tags: [Sharing]
      summary: Update a member's access level
      operationId: updateConversationMembership
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                accessLevel:
                  $ref: '#/components/schemas/AccessLevel'
      responses:
        '200':
          description: Updated membership.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    delete:
      tags: [Sharing]
      summary: Remove a member from the conversation
      operationId: deleteConversationMembership
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Membership removed.
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  ############################################################
  # Search
  ############################################################

  /v1/conversations/search:
    post:
      tags: [Search]
      summary: Semantic search across conversations
      description: |-
        Performs semantic and/or keyword search across all conversations the user has access to.
        Backed by an internal vector store (pgvector, MongoDB, etc.).
      operationId: searchConversations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchConversationsRequest'
      responses:
        '200':
          description: Search results.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchResult'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/index:
    post:
      tags: [Search]
      summary: Index a conversation transcript
      description: |-
        Indexes conversation transcript content for semantic search. Stores the
        provided transcript text as searchable content and updates the conversation
        title. The `untilEntryId` tracks which entries have been indexed.

        This endpoint is typically called by agents after processing recent
        conversation entries. The transcript text becomes searchable via
        the `/v1/conversations/search` endpoint.

        Requires a valid agent API key.
      operationId: indexConversationTranscript
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IndexTranscriptRequest'
      responses:
        '201':
          description: The index entry was created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Entry'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    Error:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
          additionalProperties: true

    AccessLevel:
      type: string
      description: Access level of a user for a conversation.
      enum:
        - owner
        - manager
        - writer
        - reader

    ConversationSummary:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
          nullable: true
        ownerUserId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        lastMessagePreview:
          type: string
          nullable: true
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
      example:
        id: "conv_01HF8XH1XABCD1234EFGH5678"
        title: "Brainstorming UI for memory service"
        ownerUserId: "user_1234"
        createdAt: "2025-01-10T14:32:05Z"
        updatedAt: "2025-01-10T14:45:12Z"
        lastMessagePreview: "Let’s try modeling forks as separate conversations…"
        accessLevel: "owner"

    Conversation:
      allOf:
        - $ref: '#/components/schemas/ConversationSummary'
        - type: object
          properties:
            forkedAtEntryId:
              type: string
              nullable: true
            forkedAtConversationId:
              type: string
              nullable: true
          example:
            id: "conv_01HF8XH1XABCD1234EFGH5678"
            title: "Brainstorming UI for memory service"
            ownerUserId: "user_1234"
            createdAt: "2025-01-10T14:32:05Z"
            updatedAt: "2025-01-10T14:45:12Z"
            lastMessagePreview: "Let's try modeling forks as separate conversations…"
            accessLevel: "owner"
            forkedAtEntryId: null
            forkedAtConversationId: null

    CreateConversationRequest:
      type: object
      properties:
        title:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true
      example:
        title: "Chat with support bot"
        metadata:
          source: "web-chat"
          projectId: "proj_7890"

    ConversationMembership:
      type: object
      properties:
        conversationId:
          type: string
        userId:
          type: string
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
        createdAt:
          type: string
          format: date-time

    ConversationForkSummary:
      type: object
      description: Summary of a forked conversation originating at a given entry.
      properties:
        conversationId:
          type: string
        forkedAtEntryId:
          type: string
          description: Entry id at which this forked conversation diverged.
        forkedAtConversationId:
          type: string
          nullable: true
          description: Conversation id where the fork occurred.
        title:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    ShareConversationRequest:
      type: object
      required:
        - userId
        - accessLevel
      properties:
        userId:
          type: string
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
        createdAt:
          type: string
          format: date-time

    ForkFromEntryRequest:
      type: object
      properties:
        title:
          type: string
          nullable: true
          description: Optional title for the new forked conversation.

    Channel:
      type: string
      description: Logical channel of the entry within the conversation.
      enum:
        - history
        - memory
        - transcript

    Entry:
      type: object
      required:
        - id
        - conversationId
        - channel
        - contentType
        - content
        - createdAt
      properties:
        id:
          type: string
        conversationId:
          type: string
        userId:
          type: string
          nullable: true
          description: |-
            Human user this entry is associated with.
            For history entries authored by a user, this is the sender.
            For agent entries, this is the user the agent is responding to.
        channel:
          $ref: '#/components/schemas/Channel'
        epoch:
          type: integer
          format: int64
          nullable: true
          description: |-
            Logical memory epoch this entry belongs to.
            For history entries this is typically null. For memory entries,
            the agent increments the epoch when starting a new memory version.
        contentType:
          type: string
          description: |-
            Describes the schema/format of the content array.
            Examples: "message", "LC4J", "SpringAI"
        content:
          type: array
          description: |-
            Opaque, agent-defined content blocks.
            Different agents may use different schemas; the memory-service
            stores and returns them without interpretation.
          items: {}
        createdAt:
          type: string
          format: date-time
      example:
        id: "entry_01HF8XJQWXYZ9876ABCD5432"
        conversationId: "conv_01HF8XH1XABCD1234EFGH5678"
        userId: "user_1234"
        channel: "history"
        epoch: null
        contentType: "message"
        content:
          - type: "text"
            text: "Here is a summary of what we discussed so far…"
        createdAt: "2025-01-10T14:40:12Z"

    CreateEntryRequest:
      type: object
      required:
        - contentType
        - content
      properties:
        userId:
          type: string
          nullable: true
          description: |-
            Human user this entry is associated with.
            For history entries authored by a user, this is the sender.
            For agent entries, this is the user the agent is responding to.
        channel:
          $ref: '#/components/schemas/Channel'
        epoch:
          type: integer
          format: int64
          nullable: true
          description: |-
            For memory entries, the epoch the agent wants this entry to
            belong to. The agent increments this when starting a new epoch.
        contentType:
          type: string
          description: |-
            Describes the schema/format of the content array.
            Examples: "message", "LC4J", "SpringAI"
        content:
          type: array
          items: {}
      example:
        userId: "user_1234"
        channel: "history"
        contentType: "message"
        content:
          - type: "text"
            text: "Based on your past chats, here are three possible approaches…"

    SyncEntriesRequest:
      type: object
      required:
        - entries
      properties:
        entries:
          type: array
          description: |-
            The desired memory epoch contents. Each entry must include the
            `memory` channel and should match the ordering that the agent expects to
            see replayed; only the agent may call this endpoint.
          items:
            $ref: '#/components/schemas/CreateEntryRequest'
      example:
        entries:
          - userId: "user_1234"
            channel: "memory"
            contentType: "LC4J"
            content:
              - type: "text"
                text: "The user asked about memory sync."
          - userId: "user_1234"
            channel: "memory"
            contentType: "LC4J"
            content:
              - type: "text"
                text: "I learned that child steps matter."

    SyncEntriesResponse:
      type: object
      properties:
        epoch:
          type: integer
          format: int64
          nullable: true
          description: The epoch number that now reflects the stored memory state.
        noOp:
          type: boolean
          description: True when the request resulted in no stored changes.
        epochIncremented:
          type: boolean
          description: True when the provided list diverged and a new epoch was started.
        entries:
          type: array
          description: List of entries that were appended during this sync.
          items:
            $ref: '#/components/schemas/Entry'
      example:
        epoch: 5
        noOp: false
        epochIncremented: true
        entries:
          - id: "entry_01HF8XJQWXYZ9876ABCD5432"
            conversationId: "conv_01HF8XH1XABCD1234EFGH5678"
            userId: "agent_memory"
            channel: "memory"
            epoch: 5
            contentType: "LC4J"
            content:
              - type: "text"
                text: "Updated memory after re-sync."
            createdAt: "2025-01-10T14:40:12Z"

    IndexTranscriptRequest:
      type: object
      required:
        - conversationId
        - transcript
        - untilEntryId
      properties:
        conversationId:
          type: string
          description: The conversation to index.
        title:
          type: string
          nullable: true
          description: Optional conversation title to store/update.
        transcript:
          type: string
          description: Transcript text to index for semantic search.
        untilEntryId:
          type: string
          description: Highest entry id covered by the index (inclusive).
      example:
        conversationId: "conv_01HF8XH1XABCD1234EFGH5678"
        title: "Conversation forking design"
        transcript: "User asked several questions about conversation forking. They want to support branching at any message with independent access control per branch."
        untilEntryId: "entry_01HF8XJQWXYZ9876ABCD5431"

    SearchConversationsRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Natural language query.
        topK:
          type: integer
          default: 20
        conversationIds:
          type: array
          items:
            type: string
          nullable: true
        before:
          type: string
          nullable: true
          description: Optional upper bound entry id for temporal filtering.
      example:
        query: "summary of memory service design decisions"
        topK: 5
        conversationIds:
          - "conv_01HF8XH1XABCD1234EFGH5678"
          - "conv_01HF8XH1XABCD1234EFGH5679"
        before: "entry_01HF8XJQWXYZ9876ABCD5431"

    SearchResult:
      type: object
      properties:
        entry:
          $ref: '#/components/schemas/Entry'
        score:
          type: number
          format: float
        highlights:
          type: string
          nullable: true
      example:
        entry:
          id: "entry_01HF8XJQWXYZ9876ABCD5430"
          conversationId: "conv_01HF8XH1XABCD1234EFGH5678"
          userId: "user_1234"
          channel: "history"
          contentType: "message"
          content:
            - type: "text"
              text: "Help me design a memory service for my agent."
          createdAt: "2025-01-10T14:32:05Z"
        score: 0.93
        highlights: "design a memory service for my agent"
