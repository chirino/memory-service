openapi: 3.1.0
info:
  title: Memory Service API
  version: v1
  description: |-
    Memory Service for AI agents.

    The service stores all entries exchanged between agents, users, and
    other actors, supports replay and forking of conversations, and exposes
    user-facing and agent-facing APIs. Conversation access is controlled by
    per-user permissions (owner, manager, writer, reader).
tags:
  - name: Conversations
    description: APIs for listing, reading, writing, and sharing conversations (user and agent views).
  - name: Search
    description: Semantic and keyword search APIs.
  - name: Sharing
    description: APIs for managing conversation ownership and sharing.
paths:

  ############################################################
  # Conversations
  ############################################################

  /v1/conversations:
    get:
      tags: [Conversations]
      summary: List conversations visible to current user
      description: |-
        Lists all conversations the current user has access to (owner, manager, writer, or reader).

        **Fork Tree Behavior**: Conversations can be forked to create branches. All forks
        share the same "conversation group" (fork tree). The `mode` parameter controls
        which conversations from each fork tree are returned.
      operationId: listConversations
      parameters:
        - name: mode
          in: query
          required: false
          description: |-
            Listing mode for conversations. Controls which conversations are returned
            from each fork tree (conversation group).
            - `all`: include all conversations the user can access (roots and forks).
            - `roots`: only include root conversations (conversations that are not forks).
            - `latest-fork`: include only the most recently updated conversation per fork tree.
              This is useful for showing a single representative conversation from each tree.
          schema:
            type: string
            enum: [all, roots, latest-fork]
            default: latest-fork
        - name: after
          in: query
          required: false
          description: Cursor for pagination; returns items after this conversation id (UUID format).
          schema:
            type: string
            format: uuid
            nullable: true
        - name: limit
          in: query
          required: false
          description: Maximum number of conversations to return.
          schema:
            type: integer
            default: 20
        - name: query
          in: query
          required: false
          description: Optional text query for basic title/metadata search.
          schema:
            type: string
            nullable: true
      responses:
        '200':
          description: A list of conversations.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationSummary'
                  nextCursor:
                    type: string
                    nullable: true
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Conversations]
      summary: Create a conversation
      description: |-
        Creates a new conversation owned by the current user.
      operationId: createConversation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: The created conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}:
    get:
      tags: [Conversations]
      summary: Get a conversation
      description: Retrieve a conversation the user has access to.
      operationId: getConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: The conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    delete:
      tags: [Conversations]
      summary: Delete a conversation
      description: |-
        Deletes a conversation. Only the owner (or manager, depending on policy) may delete.
        
        **Deleting a conversation deletes all conversations in the same fork tree** (the root conversation and all its forks). Memberships and messages associated with these conversations are also deleted.
      operationId: deleteConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Conversation deleted.
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/entries:
    get:
      tags: [Conversations]
      summary: List conversation entries
      description: |-
        Returns entries in a conversation, ordered by creation time.

        The `channel` parameter determines which logical channel of entries
        is returned:

        - `history` (default) returns the user-visible conversation between
          users and the agent.
        - `memory` returns agent memory entries which are typically not
          shown directly to end users. Memory entries are scoped to the
          calling client id derived from the API key.
      operationId: listConversationEntries
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
        - name: after
          in: query
          required: false
          description: Cursor for pagination; returns entries after this entry id (UUID format).
          schema:
            type: string
            format: uuid
            nullable: true
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
        - name: channel
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/Channel'
            default: history
          description: |-
            Channel of entries to return. Defaults to `history` for the
            user-visible conversation; `memory` returns agent memory entries
            scoped to the calling client id.
        - name: epoch
          in: query
          required: false
          schema:
            type: string
            nullable: true
            default: latest
          description: |-
            Optional epoch filter when listing the `memory` channel. Valid values
            are `latest`, `all`, or a numeric epoch identifier. Defaults to
            `latest` when not provided. The epoch selection is scoped to the
            calling client id.
      responses:
        '200':
          description: A list of entries.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Entry'
                  nextCursor:
                    type: string
                    nullable: true
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Conversations]
      summary: Append an entry
      description: |-
        Appends a new entry to the conversation.

        This endpoint is used by both end-user clients and agents.
        The service determines whether the caller is a user or an agent
        based on authentication (for example, API keys or tokens) and
        stores the entry with the appropriate internal role and visibility.
      operationId: appendConversationEntry
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEntryRequest'
      responses:
        '201':
          description: The created entry.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Entry'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/entries/sync:
    post:
      tags: [Conversations]
      summary: Synchronize the agent memory epoch
      description: |-
        Synchronizes the in-memory context for the conversation. The request body
        is a single entry whose `content` array contains all messages in the agent's
        memory. The service compares this content against the flattened content of
        all entries in the latest memory epoch.

        If the content matches exactly, it's a no-op. If the incoming content is a
        prefix extension (starts with existing content plus new items), only the
        delta is appended to the current epoch. Otherwise, a new epoch is created
        with the delta content.

        The entry must target the `memory` channel. Memory sync is scoped to the
        calling client id (from the API key). Requires a valid agent API key.
      operationId: syncConversationMemory
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEntryRequest'
      responses:
        '200':
          description: Result of the sync operation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncEntryResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/entries/{entryId}/fork:
    post:
      tags: [Conversations]
      summary: Fork a conversation at a given user entry
      description: |-
        Creates a new conversation that replays history up to just before the selected
        user entry and then diverges starting at that point.

        The fork point must be an existing user-authored entry; in the new forked
        conversation that original entry is not present and the next user entry
        is supplied by the caller in a follow-up request.
      operationId: forkConversationAtEntry
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
        - name: entryId
          in: path
          required: true
          description: Entry identifier (UUID format).
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForkFromEntryRequest'
      responses:
        '201':
          description: The newly created forked conversation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/forks:
    get:
      tags: [Conversations]
      summary: List forks for a conversation
      description: |-
        Returns all forked conversations that share the same root conversation as the
        given conversation. Each fork entry includes the message id at which it forked
        and the timestamp when the forked conversation was created.

        This is intended for UIs that want to fetch all fork points once per conversation
        and then decide how to render branch navigation (e.g., which is the oldest fork).
      operationId: listConversationForks
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Forked conversations related to this conversation's root.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationForkSummary'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/response:
    delete:
      tags: [Conversations]
      summary: Cancel an in-progress response
      description: |-
        Requests cancellation of an in-progress response stream for the conversation.
        Requires WRITER access and an authenticated user session.
      operationId: deleteConversationResponse
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cancel request accepted.
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Error'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  ############################################################
  # Sharing
  ############################################################
  /v1/ownership-transfers:
    get:
      tags: [Sharing]
      summary: List pending ownership transfers
      description: |-
        Returns all pending ownership transfers where the current user is either
        the current owner (sender) or the proposed new owner (recipient).
      operationId: listPendingTransfers
      parameters:
        - name: role
          in: query
          required: false
          description: Filter by user's role in the transfer.
          schema:
            type: string
            enum: [sender, recipient, all]
            default: all
      responses:
        '200':
          description: List of pending transfers.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OwnershipTransfer'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Sharing]
      summary: Request ownership transfer
      description: |-
        Initiates a transfer of conversation ownership to another user.

        **Constraints**:
        - Only the current owner can initiate a transfer
        - The recipient must be an existing member of the conversation
        - Only one pending transfer can exist per conversation at a time
        - If a pending transfer already exists, returns 409 Conflict

        The recipient must accept the transfer via `POST /v1/ownership-transfers/{transferId}/accept`
        for the transfer to complete. Either party can delete the pending transfer
        via `DELETE /v1/ownership-transfers/{transferId}`.
      operationId: createOwnershipTransfer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOwnershipTransferRequest'
      responses:
        '201':
          description: Transfer initiated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OwnershipTransfer'
        '400':
          description: Invalid request (recipient not a member, transfer to self).
          $ref: '#/components/responses/Error'
        '403':
          description: Not authorized (not the owner).
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: A pending transfer already exists for this conversation.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "A pending ownership transfer already exists for this conversation"
                  code:
                    type: string
                    example: "TRANSFER_ALREADY_PENDING"
                  existingTransferId:
                    type: string
                    format: uuid
                    description: ID of the existing pending transfer
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/ownership-transfers/{transferId}:
    get:
      tags: [Sharing]
      summary: Get transfer details
      description: |-
        Returns details of a specific ownership transfer. Only accessible to
        the current owner (sender) or proposed new owner (recipient).
      operationId: getTransfer
      parameters:
        - name: transferId
          in: path
          required: true
          description: Transfer identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Transfer details.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OwnershipTransfer'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    delete:
      tags: [Sharing]
      summary: Cancel or reject ownership transfer
      description: |-
        Deletes a pending ownership transfer. Can be called by either:
        - The current owner (sender) to cancel the transfer
        - The proposed new owner (recipient) to reject the transfer

        The transfer record is **hard deleted** from the database.
      operationId: deleteTransfer
      parameters:
        - name: transferId
          in: path
          required: true
          description: Transfer identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Transfer deleted successfully.
        '403':
          description: Not authorized (not the sender or recipient).
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/ownership-transfers/{transferId}/accept:
    post:
      tags: [Sharing]
      summary: Accept ownership transfer
      description: |-
        Accepts a pending ownership transfer. Only the proposed new owner
        (recipient) can accept. Upon acceptance:
        - The recipient becomes the new owner
        - The previous owner becomes a manager
        - The transfer record is deleted (transfers are always pending while they exist)
      operationId: acceptTransfer
      parameters:
        - name: transferId
          in: path
          required: true
          description: Transfer identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Transfer accepted successfully. Ownership has been transferred.
        '403':
          description: Not authorized (not the recipient).
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/{conversationId}/memberships:
    get:
      tags: [Sharing]
      summary: List conversation memberships
      description: |-
        Lists all users that have access to the conversation and their access levels.
        Any conversation member (owner, manager, writer, or reader) can list memberships.
      operationId: listConversationMemberships
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Memberships for the conversation.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    post:
      tags: [Sharing]
      summary: Share conversation with another user
      description: |-
        Grants another user access to the conversation with the specified access level.
      operationId: shareConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShareConversationRequest'
      responses:
        '201':
          description: Created membership.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []


  /v1/conversations/{conversationId}/memberships/{userId}:
    patch:
      tags: [Sharing]
      summary: Update a member's access level
      operationId: updateConversationMembership
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                accessLevel:
                  $ref: '#/components/schemas/AccessLevel'
      responses:
        '200':
          description: Updated membership.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationMembership'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []
    delete:
      tags: [Sharing]
      summary: Remove a member from the conversation
      operationId: deleteConversationMembership
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier (UUID format).
          schema:
            type: string
            format: uuid
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Membership removed.
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  ############################################################
  # Search
  ############################################################

  /v1/conversations/search:
    post:
      tags: [Search]
      summary: Semantic search across conversations
      description: |-
        Performs semantic and/or keyword search across all conversations the user has access to.
        Backed by an internal vector store (pgvector, MongoDB, etc.).
      operationId: searchConversations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchConversationsRequest'
      responses:
        '200':
          description: Search results.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchResult'
                  nextCursor:
                    type: string
                    nullable: true
        '501':
          $ref: '#/components/responses/SearchTypeUnavailable'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/index:
    post:
      tags: [Search]
      summary: Index conversation entries
      description: |-
        Indexes searchable text for conversation entries. Each item in the request
        array specifies a single entry with the text that should be searchable.

        This endpoint is called by batch indexing services after processing
        conversation entries. The indexed text becomes searchable via
        `/v1/conversations/search`.

        If an entry has already been indexed, its text is replaced with the new value.
        The entry's `indexedAt` timestamp is updated when successfully indexed.

        **Note:** This endpoint may return successfully even if vector store indexing
        fails. In that case, the indexed content is stored and a background retry task
        is created to complete the indexing asynchronously. Entries will become
        searchable once the retry task succeeds.

        Requires indexer or admin role.
      operationId: indexConversations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/IndexEntryRequest'
      responses:
        '200':
          description: Entries indexed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndexConversationsResponse'
        '403':
          description: Indexer or admin role required.
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

  /v1/conversations/unindexed:
    get:
      tags: [Search]
      summary: List entries needing indexing
      description: |-
        Returns entries from the history channel that have not yet had their
        index content generated (where `indexedContent` is null). This endpoint
        is used by batch indexing jobs to discover entries that need processing.

        Entries are returned with their full content so that callers can
        process the content before submitting index text. Results are sorted
        by `createdAt` for consistent ordering.

        Uses cursor-based pagination.

        Requires indexer or admin role.
      operationId: listUnindexedEntries
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of entries to return.
          schema:
            type: integer
            default: 100
        - name: cursor
          in: query
          required: false
          description: Pagination cursor from previous response.
          schema:
            type: string
      responses:
        '200':
          description: Paginated list of unindexed entries.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnindexedEntriesResponse'
        '403':
          description: Indexer or admin role required.
          $ref: '#/components/responses/Error'
        default:
          $ref: '#/components/responses/Error'
      security:
        - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    Error:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    SearchTypeUnavailable:
      description: Requested search type is not available on this server
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SearchTypeUnavailableError'

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
          additionalProperties: true

    SearchTypeUnavailableError:
      type: object
      description: Error response when the requested search type is not available on the server.
      properties:
        error:
          type: string
          description: Error code.
          example: search_type_unavailable
        message:
          type: string
          description: Human-readable error message.
          example: Semantic search is not available. The embedding service is disabled on this server.
        availableTypes:
          type: array
          items:
            type: string
          description: List of search types that are available on this server.
          example: [fulltext]

    AccessLevel:
      type: string
      description: Access level of a user for a conversation.
      enum:
        - owner
        - manager
        - writer
        - reader

    ConversationSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the conversation.
        title:
          type: string
          nullable: true
        ownerUserId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        lastMessagePreview:
          type: string
          nullable: true
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
      example:
        id: "550e8400-e29b-41d4-a716-446655440000"
        title: "Brainstorming UI for memory service"
        ownerUserId: "user_1234"
        createdAt: "2025-01-10T14:32:05Z"
        updatedAt: "2025-01-10T14:45:12Z"
        lastMessagePreview: "Let's try modeling forks as separate conversations…"
        accessLevel: "owner"

    Conversation:
      allOf:
        - $ref: '#/components/schemas/ConversationSummary'
        - type: object
          properties:
            forkedAtEntryId:
              type: string
              format: uuid
              nullable: true
              description: Entry ID where this conversation forked from its parent.
            forkedAtConversationId:
              type: string
              format: uuid
              nullable: true
              description: Conversation ID from which this conversation was forked.
          example:
            id: "550e8400-e29b-41d4-a716-446655440000"
            title: "Brainstorming UI for memory service"
            ownerUserId: "user_1234"
            createdAt: "2025-01-10T14:32:05Z"
            updatedAt: "2025-01-10T14:45:12Z"
            lastMessagePreview: "Let's try modeling forks as separate conversations…"
            accessLevel: "owner"
            forkedAtEntryId: null
            forkedAtConversationId: null

    CreateConversationRequest:
      type: object
      properties:
        title:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true
      example:
        title: "Chat with support bot"
        metadata:
          source: "web-chat"
          projectId: "proj_7890"

    ConversationMembership:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
          description: Unique identifier for the conversation.
        userId:
          type: string
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
        createdAt:
          type: string
          format: date-time

    ConversationForkSummary:
      type: object
      description: Summary of a forked conversation originating at a given entry.
      properties:
        conversationId:
          type: string
          format: uuid
          description: Unique identifier for the forked conversation.
        forkedAtEntryId:
          type: string
          format: uuid
          description: Entry ID at which this forked conversation diverged.
        forkedAtConversationId:
          type: string
          format: uuid
          nullable: true
          description: Conversation ID where the fork occurred.
        title:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    ShareConversationRequest:
      type: object
      required:
        - userId
        - accessLevel
      properties:
        userId:
          type: string
        accessLevel:
          $ref: '#/components/schemas/AccessLevel'
        createdAt:
          type: string
          format: date-time

    ForkFromEntryRequest:
      type: object
      properties:
        title:
          type: string
          nullable: true
          description: Optional title for the new forked conversation.

    Channel:
      type: string
      description: Logical channel of the entry within the conversation.
      enum:
        - history
        - memory

    Entry:
      type: object
      required:
        - id
        - conversationId
        - channel
        - contentType
        - content
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the entry.
        conversationId:
          type: string
          format: uuid
          description: Unique identifier for the conversation this entry belongs to.
        userId:
          type: string
          nullable: true
          description: |-
            Human user this entry is associated with.
            For history entries authored by a user, this is the sender.
            For agent entries, this is the user the agent is responding to.
        channel:
          $ref: '#/components/schemas/Channel'
        epoch:
          type: integer
          format: int64
          nullable: true
          description: |-
            Logical memory epoch this entry belongs to.
            For history entries this is typically null. For memory entries,
            the agent increments the epoch when starting a new memory version.
        contentType:
          type: string
          description: |-
            Describes the schema/format of the content array.

            **History channel entries must use `"history"` as the contentType.**
            The content array for history entries contains objects with:
            - `text` (string): The message text.
            - `role` (string): Either `"USER"` or `"AI"`.
            

            Other contentTypes (e.g., `"LC4J"`, `"SpringAI"`) may be used for
            agent memory entries.
        content:
          type: array
          description: |-
            Opaque, agent-defined content blocks.
            Different agents may use different schemas; the memory-service
            stores and returns them without interpretation.

            For history channel entries (contentType: `"history"`), each block
            contains `text` and `role` fields.
          items: {}
        createdAt:
          type: string
          format: date-time
      example:
        id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
        conversationId: "550e8400-e29b-41d4-a716-446655440000"
        userId: "user_1234"
        channel: "history"
        epoch: null
        contentType: "history"
        content:
          - text: "Here is a summary of what we discussed so far…"
            role: "AI"
        createdAt: "2025-01-10T14:40:12Z"

    CreateEntryRequest:
      type: object
      required:
        - contentType
        - content
      properties:
        userId:
          type: string
          nullable: true
          description: |-
            Human user this entry is associated with.
            For history entries authored by a user, this is the sender.
            For agent entries, this is the user the agent is responding to.
        channel:
          $ref: '#/components/schemas/Channel'
        contentType:
          type: string
          description: |-
            Describes the schema/format of the content array.

            **History channel entries must use `"history"` as the contentType.**
            The content array for history entries must contain exactly 1 object with:
            - `text` (string): The message text.
            - `role` (string): Either `"USER"` or `"AI"`.

            Other contentTypes (e.g., `"LC4J"`, `"SpringAI"`) may be used for
            agent memory entries.
        content:
          type: array
          description: |-
            For history channel entries (contentType: `"history"`), each block
            contains `text` and `role` fields.
          items: {}
        indexedContent:
          type: string
          nullable: true
          description: |-
            Optional text to index for search. Only valid for entries in the history
            channel. If provided, the entry will be indexed for search immediately
            after creation. Returns 400 Bad Request if specified for non-history channels.
      example:
        userId: "user_1234"
        channel: "history"
        contentType: "history"
        content:
          - text: "Based on your past chats, here are three possible approaches…"
            role: "AI"

    SyncEntryResponse:
      type: object
      properties:
        epoch:
          type: integer
          format: int64
          nullable: true
          description: The epoch number that now reflects the stored memory state.
        noOp:
          type: boolean
          description: True when the request resulted in no stored changes.
        epochIncremented:
          type: boolean
          description: True when the provided list diverged and a new epoch was started.
        entry:
          $ref: '#/components/schemas/Entry'
          nullable: true
          description: The entry that was appended during this sync, or null if no-op.
      example:
        epoch: 5
        noOp: false
        epochIncremented: true
        entry:
          id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
          conversationId: "550e8400-e29b-41d4-a716-446655440000"
          userId: "agent_memory"
          channel: "memory"
          epoch: 5
          contentType: "LC4J"
          content:
            - type: "text"
              text: "First message in memory."
            - type: "text"
              text: "Second message added during sync."
          createdAt: "2025-01-10T14:40:12Z"

    IndexEntryRequest:
      type: object
      required:
        - conversationId
        - entryId
        - indexedContent
      properties:
        conversationId:
          type: string
          format: uuid
          description: The conversation containing the entry.
        entryId:
          type: string
          format: uuid
          description: The entry ID to index.
        indexedContent:
          type: string
          description: The searchable text for this entry.
      example:
        conversationId: "550e8400-e29b-41d4-a716-446655440000"
        entryId: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
        indexedContent: "User asked about conversation forking and branching strategies"

    IndexConversationsResponse:
      type: object
      properties:
        indexed:
          type: integer
          description: |-
            Number of entries processed. These entries have their indexed content
            stored and will be searchable. If vector store indexing failed for some
            entries, they will become searchable asynchronously via background retry.
      example:
        indexed: 3

    UnindexedEntriesResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/UnindexedEntry'
        cursor:
          type: string
          nullable: true
          description: Cursor for fetching next page. Null when no more results.
      example:
        data:
          - conversationId: "550e8400-e29b-41d4-a716-446655440000"
            entry:
              id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
              channel: "history"
              contentType: "history"
              content:
                - text: "Help me design a memory service"
                  role: "USER"
              createdAt: "2025-01-10T14:40:12Z"
        cursor: "eyJjcmVhdGVkQXQiOiIyMDI1LTAxLTEwVDE0OjQwOjEyWiJ9"

    UnindexedEntry:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
        entry:
          $ref: '#/components/schemas/Entry'

    SearchConversationsRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Natural language query.
        searchType:
          type: string
          enum: [auto, semantic, fulltext]
          default: auto
          description: |
            The search method to use:
            - `auto` (default): Try semantic (vector) search first, fall back to full-text if no results or unavailable
            - `semantic`: Use only vector/embedding-based semantic search
            - `fulltext`: Use only PostgreSQL full-text search with GIN index

            If the requested search type is not available on the server, a 501 (Not Implemented)
            error is returned with details about which search types are available.
        after:
          type: string
          nullable: true
          description: Cursor for pagination; returns items after this result.
        limit:
          type: integer
          default: 20
          description: Maximum number of results to return.
        includeEntry:
          type: boolean
          default: true
          description: Whether to include the full entry in results. Set to false to reduce response size when only metadata is needed.
        groupByConversation:
          type: boolean
          default: true
          description: |
            When true (default), groups results by conversation and returns only
            the highest-scoring entry per conversation. When false, returns all
            matching entries ordered by score.
      example:
        query: "summary of memory service design decisions"
        searchType: auto
        limit: 20
        includeEntry: true
        groupByConversation: true

    SearchResult:
      type: object
      properties:
        conversationId:
          type: string
          format: uuid
          description: Unique identifier of the conversation containing this entry.
        conversationTitle:
          type: string
          description: Title of the conversation containing this entry.
        entryId:
          type: string
          format: uuid
          description: ID of the matched entry. Always present for deep-linking.
        score:
          type: number
          format: float
        highlights:
          type: string
          nullable: true
        entry:
          allOf:
            - $ref: '#/components/schemas/Entry'
          description: The matched entry. Only included when includeEntry is true in the request.
      example:
        conversationId: "550e8400-e29b-41d4-a716-446655440000"
        conversationTitle: "Memory Service Design Discussion"
        score: 0.93
        highlights: "design a memory service for my agent"
        entry:
          id: "6ba7b810-9dad-11d1-80b4-00c04fd430c9"
          conversationId: "550e8400-e29b-41d4-a716-446655440000"
          userId: "user_1234"
          channel: "history"
          contentType: "history"
          content:
            - text: "Help me design a memory service for my agent."
              role: "USER"
          createdAt: "2025-01-10T14:32:05Z"

    OwnershipTransfer:
      type: object
      description: |-
        Represents a pending ownership transfer request.
        Transfers are always "pending" while they exist; accepted/rejected transfers
        are hard deleted from the database.
      required:
        - id
        - conversationId
        - fromUserId
        - toUserId
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the transfer.
        conversationId:
          type: string
          format: uuid
          description: The conversation being transferred.
        conversationTitle:
          type: string
          nullable: true
          description: Title of the conversation (for display purposes).
        fromUserId:
          type: string
          description: Current owner initiating the transfer.
        toUserId:
          type: string
          description: Proposed new owner (recipient).
        createdAt:
          type: string
          format: date-time
          description: When the transfer was initiated.
      example:
        id: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
        conversationId: "550e8400-e29b-41d4-a716-446655440000"
        conversationTitle: "Help with React hooks"
        fromUserId: "user_john_doe"
        toUserId: "user_jane_smith"
        createdAt: "2025-01-28T10:30:00Z"

    CreateOwnershipTransferRequest:
      type: object
      required:
        - conversationId
        - newOwnerUserId
      properties:
        conversationId:
          type: string
          format: uuid
          description: The conversation to transfer ownership of.
        newOwnerUserId:
          type: string
          description: User ID of the proposed new owner. Must be an existing member.
      example:
        conversationId: "550e8400-e29b-41d4-a716-446655440000"
        newOwnerUserId: "user_jane_smith"
