syntax = "proto3";
package memory.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";

option java_multiple_files = true;
option java_package = "io.github.chirino.memory.grpc.v1";

// UUID fields are represented as 16-byte big-endian binary values.
// Use the most significant 64 bits first, then least significant 64 bits.
// Example conversion (Java):
//   ByteBuffer buffer = ByteBuffer.allocate(16);
//   buffer.putLong(uuid.getMostSignificantBits());
//   buffer.putLong(uuid.getLeastSignificantBits());
//   return buffer.array();

message PageRequest {
  string page_token = 1;
  int32 page_size = 2;
}

message PageInfo {
  string next_page_token = 1;
}

// ConversationListMode controls which conversations are returned from each fork tree.
// Conversations can be forked to create branches. All forks share the same
// "conversation group" (fork tree). This mode determines which conversations
// from each fork tree are included in list results.
enum ConversationListMode {
  // Unspecified defaults to LATEST_FORK.
  CONVERSATION_LIST_MODE_UNSPECIFIED = 0;
  // Include all conversations the user can access (roots and forks).
  ALL = 1;
  // Only include root conversations (conversations that are not forks).
  ROOTS = 2;
  // Include only the most recently updated conversation per fork tree (default).
  // This is useful for showing a single representative conversation from each tree.
  LATEST_FORK = 3;
}

enum AccessLevel {
  ACCESS_LEVEL_UNSPECIFIED = 0;
  OWNER = 1;
  MANAGER = 2;
  WRITER = 3;
  READER = 4;
}

enum Channel {
  CHANNEL_UNSPECIFIED = 0;
  HISTORY = 1;
  MEMORY = 2;
  TRANSCRIPT = 3;
}

message ConversationSummary {
  // Unique identifier (UUID as 16-byte big-endian binary)
  bytes id = 1;
  string title = 2;
  string owner_user_id = 3;
  string created_at = 4;
  string updated_at = 5;
  string last_message_preview = 6;
  AccessLevel access_level = 7;
}

message Conversation {
  // Unique identifier (UUID as 16-byte big-endian binary)
  bytes id = 1;
  string title = 2;
  string owner_user_id = 3;
  string created_at = 4;
  string updated_at = 5;
  string last_message_preview = 6;
  AccessLevel access_level = 7;
  reserved 8; // conversation_group_id removed
  // Entry ID where this conversation forked (empty if root)
  bytes forked_at_entry_id = 9;
  // Conversation ID from which this was forked (empty if root)
  bytes forked_at_conversation_id = 10;
}

message ConversationMembership {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  string user_id = 2;
  AccessLevel access_level = 3;
  string created_at = 4;
  reserved 5; // old conversation_group_id field number
}

message ConversationForkSummary {
  // Forked conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  reserved 2; // conversation_group_id removed
  // Entry ID at which this conversation forked
  bytes forked_at_entry_id = 3;
  // Conversation ID from which this was forked
  bytes forked_at_conversation_id = 4;
  string title = 5;
  string created_at = 6;
}

message CreateConversationRequest {
  string title = 1;
  google.protobuf.Struct metadata = 2;
}

message ListConversationsRequest {
  // Controls which conversations are returned from each fork tree.
  // See ConversationListMode for details on each mode.
  ConversationListMode mode = 1;
  // Optional text query for basic title/metadata search.
  string query = 2;
  PageRequest page = 3;
}

message ListConversationsResponse {
  repeated ConversationSummary conversations = 1;
  PageInfo page_info = 2;
}

message GetConversationRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
}

message DeleteConversationRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
}

message ForkConversationRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  // Entry ID to fork at (UUID as 16-byte big-endian binary)
  bytes entry_id = 2;
  string title = 3;
}

message ListForksRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
}

message ListForksResponse {
  repeated ConversationForkSummary forks = 1;
}

message CreateEntryRequest {
  string user_id = 1;
  Channel channel = 2;
  int64 epoch = 3;
  string content_type = 4;
  repeated google.protobuf.Value content = 5;
  // Optional text to index for search (history channel only)
  optional string indexed_content = 6;
}

message SyncEntriesRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  // Single entry containing all messages in the agent's memory.
  // The content array holds all messages; comparison is done against
  // the flattened content of existing entries in the latest epoch.
  CreateEntryRequest entry = 2;
}

message SyncEntriesResponse {
  optional int64 epoch = 1;
  bool no_op = 2;
  bool epoch_incremented = 3;
  // The entry that was appended during this sync, or empty if no-op.
  optional Entry entry = 4;
}

message AppendEntryRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  CreateEntryRequest entry = 2;
}

message ListEntriesRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  Channel channel = 2;
  string epoch_filter = 3;
  PageRequest page = 4;
}

message ListEntriesResponse {
  repeated Entry entries = 1;
  PageInfo page_info = 2;
}

message Entry {
  // Unique identifier (UUID as 16-byte big-endian binary)
  bytes id = 1;
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 2;
  string user_id = 3;
  Channel channel = 4;
  int64 epoch = 5;
  string content_type = 6;
  repeated google.protobuf.Value content = 7;
  string created_at = 8;
}

message ListMembershipsRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
}

message ListMembershipsResponse {
  repeated ConversationMembership memberships = 1;
}

message ShareConversationRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  string user_id = 2;
  AccessLevel access_level = 3;
}

message UpdateMembershipRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  string member_user_id = 2;
  AccessLevel access_level = 3;
}

message DeleteMembershipRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  string member_user_id = 2;
}

// Ownership Transfer messages
message OwnershipTransfer {
  // Transfer identifier (UUID as 16-byte big-endian binary)
  bytes id = 1;
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 2;
  string conversation_title = 3;
  string from_user_id = 4;
  string to_user_id = 5;
  string created_at = 6;
}

enum TransferRole {
  TRANSFER_ROLE_UNSPECIFIED = 0;
  SENDER = 1;
  RECIPIENT = 2;
}

message ListOwnershipTransfersRequest {
  TransferRole role = 1;
}

message ListOwnershipTransfersResponse {
  repeated OwnershipTransfer transfers = 1;
}

message GetOwnershipTransferRequest {
  // Transfer identifier (UUID as 16-byte big-endian binary)
  bytes transfer_id = 1;
}

message CreateOwnershipTransferRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  string new_owner_user_id = 2;
}

message AcceptOwnershipTransferRequest {
  // Transfer identifier (UUID as 16-byte big-endian binary)
  bytes transfer_id = 1;
}

message DeleteOwnershipTransferRequest {
  // Transfer identifier (UUID as 16-byte big-endian binary)
  bytes transfer_id = 1;
}

message SearchEntriesRequest {
  string query = 1;
  // Cursor for pagination; returns items after this result
  string after = 2;
  // Maximum number of results to return (default 20)
  int32 limit = 3;
  // Whether to include the full entry in results. Defaults to true.
  optional bool include_entry = 4;
}

message SearchEntriesResponse {
  repeated SearchResult results = 1;
  string next_cursor = 2;
}

message SearchResult {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  // Title of the conversation containing this entry
  string conversation_title = 2;
  // Entry identifier (UUID as 16-byte big-endian binary). Always present for deep-linking.
  bytes entry_id = 3;
  float score = 4;
  string highlights = 5;
  // The matched entry. Only included when include_entry is true in the request.
  Entry entry = 6;
}

// Index entries request - flat array of entries to index
message IndexConversationsRequest {
  repeated IndexEntryRequest entries = 1;
}

message IndexEntryRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  // Entry identifier (UUID as 16-byte big-endian binary)
  bytes entry_id = 2;
  // The searchable text for this entry
  string indexed_content = 3;
}

message IndexConversationsResponse {
  // Number of entries processed
  int32 indexed = 1;
}

// List unindexed entries - for batch indexing discovery
message ListUnindexedEntriesRequest {
  int32 limit = 1;
  optional string cursor = 2;
}

message ListUnindexedEntriesResponse {
  repeated UnindexedEntry entries = 1;
  // Cursor for next page, absent when no more results
  optional string cursor = 2;
}

message UnindexedEntry {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  Entry entry = 2;
}

message HealthResponse {
  string status = 1;
}

service SystemService {
  rpc GetHealth(google.protobuf.Empty) returns (HealthResponse);
}

service ConversationsService {
  // ListConversations returns conversations the user has access to.
  // The mode parameter controls which conversations from each fork tree are returned.
  // See ConversationListMode for available modes.
  rpc ListConversations(ListConversationsRequest) returns (ListConversationsResponse);
  rpc CreateConversation(CreateConversationRequest) returns (Conversation);
  rpc GetConversation(GetConversationRequest) returns (Conversation);
  // DeleteConversation deletes a conversation. Deleting a conversation deletes all conversations in the same fork tree (the root conversation and all its forks). Memberships and entries associated with these conversations are also deleted.
  rpc DeleteConversation(DeleteConversationRequest) returns (google.protobuf.Empty);
  rpc ForkConversation(ForkConversationRequest) returns (Conversation);
  rpc ListForks(ListForksRequest) returns (ListForksResponse);
}

service ConversationMembershipsService {
  rpc ListMemberships(ListMembershipsRequest) returns (ListMembershipsResponse);
  rpc ShareConversation(ShareConversationRequest) returns (ConversationMembership);
  rpc UpdateMembership(UpdateMembershipRequest) returns (ConversationMembership);
  rpc DeleteMembership(DeleteMembershipRequest) returns (google.protobuf.Empty);
}

service OwnershipTransfersService {
  // List pending ownership transfers for the current user
  rpc ListOwnershipTransfers(ListOwnershipTransfersRequest) returns (ListOwnershipTransfersResponse);
  // Get a specific ownership transfer
  rpc GetOwnershipTransfer(GetOwnershipTransferRequest) returns (OwnershipTransfer);
  // Create a new ownership transfer (initiates transfer to another user)
  rpc CreateOwnershipTransfer(CreateOwnershipTransferRequest) returns (OwnershipTransfer);
  // Accept an ownership transfer (recipient becomes owner, sender becomes manager)
  rpc AcceptOwnershipTransfer(AcceptOwnershipTransferRequest) returns (google.protobuf.Empty);
  // Delete/cancel an ownership transfer
  rpc DeleteOwnershipTransfer(DeleteOwnershipTransferRequest) returns (google.protobuf.Empty);
}

service EntriesService {
  rpc ListEntries(ListEntriesRequest) returns (ListEntriesResponse);
  rpc AppendEntry(AppendEntryRequest) returns (Entry);
  rpc SyncEntries(SyncEntriesRequest) returns (SyncEntriesResponse);
}

service SearchService {
  rpc SearchConversations(SearchEntriesRequest) returns (SearchEntriesResponse);
  // Index conversation entries for search. Requires indexer or admin role.
  rpc IndexConversations(IndexConversationsRequest) returns (IndexConversationsResponse);
  // List entries needing indexing. Requires indexer or admin role.
  rpc ListUnindexedEntries(ListUnindexedEntriesRequest) returns (ListUnindexedEntriesResponse);
}

service ResponseResumerService {
  // Stream response tokens for a conversation
  rpc StreamResponseTokens(stream StreamResponseTokenRequest) returns (stream StreamResponseTokenResponse);

  // Replay cached response tokens from a resume position
  rpc ReplayResponseTokens(ReplayResponseTokensRequest) returns (stream ReplayResponseTokensResponse);

  // Cancel an in-progress response
  rpc CancelResponse(CancelResponseRequest) returns (CancelResponseResponse);

  // Check if response resumer is enabled
  rpc IsEnabled(google.protobuf.Empty) returns (IsEnabledResponse);

  // Check which conversations have responses in progress
  rpc CheckConversations(CheckConversationsRequest) returns (CheckConversationsResponse);
}

message StreamResponseTokenRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary, only in first message)
  bytes conversation_id = 1;
  string token = 2;            // Token content
  bool complete = 3;           // Set to true in final message
}

message StreamResponseTokenResponse {
  bool success = 1;
  string error_message = 2;    // Only set if success=false
  int64 current_offset = 3;    // Current cumulative byte offset
  bool cancel_requested = 4;   // True if server requests cancellation
}

message ReplayResponseTokensRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
  // Field 2 (resume_position) removed - always replays from beginning
}

message ReplayResponseTokensResponse {
  string token = 1;
  int64 offset = 2;            // Cumulative byte offset after this token
}

message CancelResponseRequest {
  // Conversation identifier (UUID as 16-byte big-endian binary)
  bytes conversation_id = 1;
}

message CancelResponseResponse {
  bool accepted = 1;
}

message IsEnabledResponse {
  bool enabled = 1;
}

message CheckConversationsRequest {
  // Conversation identifiers (UUID as 16-byte big-endian binary each)
  repeated bytes conversation_ids = 1;
}

message CheckConversationsResponse {
  // Conversation IDs with responses in progress (UUID as 16-byte big-endian binary each)
  repeated bytes conversation_ids = 1;
}
