syntax = "proto3";
package memory.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";

option java_multiple_files = true;
option java_package = "io.github.chirino.memory.grpc.v1";

message PageRequest {
  string page_token = 1;
  int32 page_size = 2;
}

message PageInfo {
  string next_page_token = 1;
}

enum ConversationListMode {
  CONVERSATION_LIST_MODE_UNSPECIFIED = 0;
  ALL = 1;
  ROOTS = 2;
  LATEST_FORK = 3;
}

enum AccessLevel {
  ACCESS_LEVEL_UNSPECIFIED = 0;
  OWNER = 1;
  MANAGER = 2;
  WRITER = 3;
  READER = 4;
}

enum Channel {
  CHANNEL_UNSPECIFIED = 0;
  HISTORY = 1;
  MEMORY = 2;
  SUMMARY = 3;
}

message ConversationSummary {
  string id = 1;
  string title = 2;
  string owner_user_id = 3;
  string created_at = 4;
  string updated_at = 5;
  string last_message_preview = 6;
  AccessLevel access_level = 7;
}

message Conversation {
  string id = 1;
  string title = 2;
  string owner_user_id = 3;
  string created_at = 4;
  string updated_at = 5;
  string last_message_preview = 6;
  AccessLevel access_level = 7;
  reserved 8; // conversation_group_id removed
  string forked_at_entry_id = 9;
  string forked_at_conversation_id = 10;
}

message ConversationMembership {
  string conversation_id = 1;
  string user_id = 2;
  AccessLevel access_level = 3;
  string created_at = 4;
  reserved 5; // old conversation_group_id field number
}

message ConversationForkSummary {
  string conversation_id = 1;
  reserved 2; // conversation_group_id removed
  string forked_at_entry_id = 3;
  string forked_at_conversation_id = 4;
  string title = 5;
  string created_at = 6;
}

message CreateConversationRequest {
  string title = 1;
  google.protobuf.Struct metadata = 2;
}

message ListConversationsRequest {
  ConversationListMode mode = 1;
  string query = 2;
  PageRequest page = 3;
}

message ListConversationsResponse {
  repeated ConversationSummary conversations = 1;
  PageInfo page_info = 2;
}

message GetConversationRequest {
  string conversation_id = 1;
}

message DeleteConversationRequest {
  string conversation_id = 1;
}

message ForkConversationRequest {
  string conversation_id = 1;
  string entry_id = 2;
  string title = 3;
}

message ListForksRequest {
  string conversation_id = 1;
}

message ListForksResponse {
  repeated ConversationForkSummary forks = 1;
}

message TransferOwnershipRequest {
  string conversation_id = 1;
  string new_owner_user_id = 2;
}

message CreateEntryRequest {
  string user_id = 1;
  Channel channel = 2;
  int64 epoch = 3;
  string content_type = 4;
  repeated google.protobuf.Value content = 5;
}

message SyncEntriesRequest {
  string conversation_id = 1;
  repeated CreateEntryRequest entries = 2;
}

message SyncEntriesResponse {
  optional int64 epoch = 1;
  bool no_op = 2;
  bool epoch_incremented = 3;
  repeated Entry entries = 4;
}

message AppendEntryRequest {
  string conversation_id = 1;
  CreateEntryRequest entry = 2;
}

message ListEntriesRequest {
  string conversation_id = 1;
  Channel channel = 2;
  string epoch_filter = 3;
  PageRequest page = 4;
}

message ListEntriesResponse {
  repeated Entry entries = 1;
  PageInfo page_info = 2;
}

message Entry {
  string id = 1;
  string conversation_id = 2;
  string user_id = 3;
  Channel channel = 4;
  int64 epoch = 5;
  string content_type = 6;
  repeated google.protobuf.Value content = 7;
  string created_at = 8;
}

message ListMembershipsRequest {
  string conversation_id = 1;
}

message ListMembershipsResponse {
  repeated ConversationMembership memberships = 1;
}

message ShareConversationRequest {
  string conversation_id = 1;
  string user_id = 2;
  AccessLevel access_level = 3;
}

message UpdateMembershipRequest {
  string conversation_id = 1;
  string member_user_id = 2;
  AccessLevel access_level = 3;
}

message DeleteMembershipRequest {
  string conversation_id = 1;
  string member_user_id = 2;
}

message SearchEntriesRequest {
  string query = 1;
  int32 top_k = 2;
  repeated string conversation_ids = 3;
  string before = 4;
}

message SearchEntriesResponse {
  repeated SearchResult results = 1;
}

message SearchResult {
  Entry entry = 1;
  float score = 2;
  string highlights = 3;
}

message CreateSummaryRequest {
  string conversation_id = 1;
  string title = 2;
  string summary = 3;
  string until_entry_id = 4;
  string summarized_at = 5;
}

message HealthResponse {
  string status = 1;
}

service SystemService {
  rpc GetHealth(google.protobuf.Empty) returns (HealthResponse);
}

service ConversationsService {
  rpc ListConversations(ListConversationsRequest) returns (ListConversationsResponse);
  rpc CreateConversation(CreateConversationRequest) returns (Conversation);
  rpc GetConversation(GetConversationRequest) returns (Conversation);
  // DeleteConversation deletes a conversation. Deleting a conversation deletes all conversations in the same fork tree (the root conversation and all its forks). Memberships and entries associated with these conversations are also deleted.
  rpc DeleteConversation(DeleteConversationRequest) returns (google.protobuf.Empty);
  rpc ForkConversation(ForkConversationRequest) returns (Conversation);
  rpc ListForks(ListForksRequest) returns (ListForksResponse);
  rpc TransferOwnership(TransferOwnershipRequest) returns (google.protobuf.Empty);
}

service ConversationMembershipsService {
  rpc ListMemberships(ListMembershipsRequest) returns (ListMembershipsResponse);
  rpc ShareConversation(ShareConversationRequest) returns (ConversationMembership);
  rpc UpdateMembership(UpdateMembershipRequest) returns (ConversationMembership);
  rpc DeleteMembership(DeleteMembershipRequest) returns (google.protobuf.Empty);
}

service EntriesService {
  rpc ListEntries(ListEntriesRequest) returns (ListEntriesResponse);
  rpc AppendEntry(AppendEntryRequest) returns (Entry);
  rpc SyncEntries(SyncEntriesRequest) returns (SyncEntriesResponse);
}

service SearchService {
  rpc SearchEntries(SearchEntriesRequest) returns (SearchEntriesResponse);
  rpc CreateSummary(CreateSummaryRequest) returns (Entry);
}

service ResponseResumerService {
  // Stream response tokens for a conversation
  rpc StreamResponseTokens(stream StreamResponseTokenRequest) returns (stream StreamResponseTokenResponse);
  
  // Replay cached response tokens from a resume position
  rpc ReplayResponseTokens(ReplayResponseTokensRequest) returns (stream ReplayResponseTokensResponse);

  // Cancel an in-progress response
  rpc CancelResponse(CancelResponseRequest) returns (CancelResponseResponse);
  
  // Check if response resumer is enabled
  rpc IsEnabled(google.protobuf.Empty) returns (IsEnabledResponse);

  // Check which conversations have responses in progress
  rpc CheckConversations(CheckConversationsRequest) returns (CheckConversationsResponse);
}

message StreamResponseTokenRequest {
  string conversation_id = 1;  // Only in first message
  string token = 2;            // Token content
  bool complete = 3;           // Set to true in final message
}

message StreamResponseTokenResponse {
  bool success = 1;
  string error_message = 2;    // Only set if success=false
  int64 current_offset = 3;    // Current cumulative byte offset
  bool cancel_requested = 4;   // True if server requests cancellation
}

message ReplayResponseTokensRequest {
  string conversation_id = 1;
  // Field 2 (resume_position) removed - always replays from beginning
}

message ReplayResponseTokensResponse {
  string token = 1;
  int64 offset = 2;            // Cumulative byte offset after this token
}

message CancelResponseRequest {
  string conversation_id = 1;
}

message CancelResponseResponse {
  bool accepted = 1;
}

message IsEnabledResponse {
  bool enabled = 1;
}

message CheckConversationsRequest {
  repeated string conversation_ids = 1;
}

message CheckConversationsResponse {
  repeated string conversation_ids = 1;  // Only IDs with responses in progress
}
