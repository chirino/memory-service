# To be able to use the pgvector dev service, we need to set the image name
quarkus.datasource.devservices.image-name=pgvector/pgvector:pg17

# Dev profile: local PostgreSQL (used for quarkus:dev and manual runs)
%dev.quarkus.http.port=8081

# Liquibase for PostgreSQL
%dev.quarkus.liquibase.migrate-at-start=true
%prod.quarkus.liquibase.migrate-at-start=true
quarkus.liquibase.change-log=db/changelog/db.changelog-master.yaml

# Test profile: use Dev Services to start a PostgreSQL container automatically.
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.liquibase.migrate-at-start=true
%test.quarkus.liquibase.change-log=db/changelog/db.changelog-master.yaml

# Prefer JSONB for JSON mappings on PostgreSQL
hibernate.type.preferred_json_format=jsonb

# Use built-in JSON mapping for DB only, ignore REST-specific formatting customization
quarkus.hibernate-orm.mapping.format.global=ignore

# Memory service provider selection
memory-service.datastore.type=postgres
memory-service.cache.type=none
memory-service.cache.epoch.ttl=PT10M
memory-service.vector.type=none

# OIDC / Keycloak configuration (following Quarkus Keycloak authorization guide)
# In production (e.g., docker-compose), use the Keycloak realm backing the memory service.
%prod.quarkus.oidc.auth-server-url=http://keycloak:8080/realms/memory-service
quarkus.oidc.client-id=memory-service-client
quarkus.oidc.credentials.secret=${KEYCLOAK_CLIENT_SECRET:change-me}
quarkus.oidc.application-type=service
quarkus.oidc.roles.source=accesstoken

quarkus.smallrye-openapi.path=/q/openapi

quarkus.http.auth.permission.authenticated.paths=/*
quarkus.http.auth.permission.authenticated.methods=GET,POST,PUT,PATCH,DELETE,HEAD
quarkus.http.auth.permission.authenticated.policy=authenticated

# MongoDB configuration (used when memory-service.datastore.type=mongo or mongodb)
quarkus.mongodb.database=memory_service

# Liquibase for MongoDB (no-op changelog for now)
quarkus.liquibase-mongodb.migrate-at-start=false
quarkus.liquibase-mongodb.change-log=db/changelog-mongodb/db.changelog-master.yaml

%test.quarkus.liquibase-mongodb.migrate-at-start=true
%test.quarkus.liquibase-mongodb.change-log=db/changelog-mongodb/db.changelog-master.yaml

# Data encryption configuration - Uses the plain provider unless overridden
data.encryption.providers=plain
data.encryption.provider.plain.type=plain

# API keys that can be used by trusted agents (e.g., MemoryServiceChatMemory).
# Each client id can have one or more keys:
# memory-service.api-keys.agent-a=agent-a-key-1,agent-a-key-2
# memory-service.api-keys.agent-b=agent-b-key-1

# Enable HTTP access logging
quarkus.http.access-log.enabled=true
quarkus.log.level=INFO
quarkus.log.category."io.quarkus.http.access-log".level=INFO
quarkus.log.category."io.github.chirino.memory".level=INFO
quarkus.log.category."io.github.chirino.memory.response".level=INFO
quarkus.log.category."io.github.chirino.memory.membership.audit".level=INFO

# Quarkus OIDC adapter + runtime validation
quarkus.log.category."io.quarkus.oidc".level=DEBUG
quarkus.log.category."io.quarkus.oidc.runtime".level=DEBUG

# Underlying JWT validation libraries
quarkus.log.category."io.smallrye.jwt".level=DEBUG
quarkus.log.category."io.smallrye.jwt.auth".level=DEBUG

# Vert.x auth layer observations
quarkus.log.category."io.vertx.ext.auth".level=DEBUG

quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.grpc-health.enabled=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.generate-code.grpc.scan-for-proto=io.github.chirino.memory-service:memory-service-proto-quarkus

# Public paths (accessible without authentication)
quarkus.http.auth.permission.public.paths=/q/*,/v1/health
quarkus.http.auth.permission.public.policy=permit

# Allow CORS preflight requests without authentication
quarkus.http.auth.permission.cors-preflight.paths=/*
quarkus.http.auth.permission.cors-preflight.methods=OPTIONS
quarkus.http.auth.permission.cors-preflight.policy=permit

# Delay authentication until required (allows CORS preflight to work)
quarkus.http.auth.proactive=false

# Admin path requires authentication (role checking is application-level)
quarkus.http.auth.permission.admin.paths=/v1/admin/*
quarkus.http.auth.permission.admin.methods=GET,POST,PUT,PATCH,DELETE,HEAD
quarkus.http.auth.permission.admin.policy=authenticated

# Admin audit justification (default: optional)
memory-service.admin.require-justification=false

# Role mapping defaults (uncomment to customize)
# memory-service.roles.admin.oidc.role=admin
# memory-service.roles.auditor.oidc.role=auditor
# memory-service.roles.admin.users=
# memory-service.roles.auditor.users=
# memory-service.roles.admin.clients=
# memory-service.roles.auditor.clients=

# Task processor configuration
memory-service.tasks.retry-delay=PT10M
memory-service.tasks.processor-interval=1m
memory-service.tasks.batch-size=100
memory-service.tasks.stale-claim-timeout=PT5M

# Eviction configuration
memory-service.eviction.batch-size=1000
memory-service.eviction.batch-delay-ms=100

%dev.quarkus.datasource.db-kind=postgresql
%dev.quarkus.redis.devservices.enabled=true
%dev.memory-service.cache.type=redis

%test.quarkus.datasource.db-kind=postgresql
%test.quarkus.redis.devservices.enabled=true
%test.memory-service.cache.type=redis

# CORS configuration (disabled by default, enable via QUARKUS_HTTP_CORS=true and QUARKUS_HTTP_CORS_ORIGINS)
quarkus.http.cors=false
quarkus.http.cors.methods=GET,POST,PUT,PATCH,DELETE,OPTIONS
quarkus.http.cors.headers=accept,authorization,content-type,x-requested-with
quarkus.http.cors.exposed-headers=content-type,authorization
quarkus.http.cors.access-control-allow-credentials=true
