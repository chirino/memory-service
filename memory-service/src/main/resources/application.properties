# Core datasource configuration (can be overridden at runtime)
# We move these to %dev and %prod to avoid breaking %test Dev Services
%dev.quarkus.datasource.db-kind=postgresql
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/memory_service
%prod.quarkus.datasource.db-kind=postgresql
%prod.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/memory_service

# To be able to use the pgvector dev service, we need to set the image name
quarkus.datasource.devservices.image-name=pgvector/pgvector:pg17

# Dev profile: local PostgreSQL (used for quarkus:dev and manual runs)
%dev.quarkus.http.port=8081

# Liquibase for PostgreSQL
%dev.quarkus.liquibase.migrate-at-start=true
%prod.quarkus.liquibase.migrate-at-start=true
quarkus.liquibase.change-log=db/changelog/db.changelog-master.yaml

# Test profile: use Dev Services to start a PostgreSQL container automatically.
%test.quarkus.datasource.db-kind=postgresql
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.liquibase.migrate-at-start=true
%test.quarkus.liquibase.change-log=db/changelog/db.changelog-master.yaml

# Prefer JSONB for JSON mappings on PostgreSQL
%dev.hibernate.type.preferred_json_format=jsonb
%test.hibernate.type.preferred_json_format=jsonb

# Use built-in JSON mapping for DB only, ignore REST-specific formatting customization
quarkus.hibernate-orm.mapping.format.global=ignore

# Memory service provider selection
memory.datastore.type=postgres
memory.cache.type=none
memory.vector.type=none

# OIDC / Keycloak configuration (following Quarkus Keycloak authorization guide)
# In production (e.g., docker-compose), use the Keycloak realm backing the memory service.
%prod.quarkus.oidc.auth-server-url=http://keycloak:8080/realms/memory-service
quarkus.oidc.client-id=memory-service-client
quarkus.oidc.credentials.secret=${KEYCLOAK_CLIENT_SECRET:change-me}
quarkus.oidc.application-type=service
quarkus.oidc.roles.source=accesstoken

quarkus.smallrye-openapi.path=/q/openapi

quarkus.http.auth.permission.authenticated.paths=/*
quarkus.http.auth.permission.authenticated.policy=authenticated

# MongoDB configuration (used when memory.datastore.type=mongo or mongodb)
quarkus.mongodb.database=memory_service

# Liquibase for MongoDB (no-op changelog for now)
quarkus.liquibase-mongodb.migrate-at-start=false
quarkus.liquibase-mongodb.change-log=db/changelog-mongodb/db.changelog-master.yaml

%test.quarkus.liquibase-mongodb.migrate-at-start=true
%test.quarkus.liquibase-mongodb.change-log=db/changelog-mongodb/db.changelog-master.yaml

# Data encryption configuration - Uses the plain provider unless overridden
data.encryption.providers=plain
data.encryption.provider.plain.type=plain

# Comma-separated list of API keys that can be used by trusted agents (e.g., MemoryServiceChatMemory).
# Example:
# memory.api-keys=agent-key-1,agent-key-2

# Enable HTTP access logging
quarkus.http.access-log.enabled=true
quarkus.log.category."io.quarkus.http.access-log".level=INFO
quarkus.log.category."io.github.chirino.memory".level=DEBUG

quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.grpc-health.enabled=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.generate-code.grpc.scan-for-proto=io.github.chirino.memory-service:memory-service-proto
