databaseChangeLog:
  - changeSet:
      id: 1-initial-schema
      author: memory-service
      changes:
        - sqlFile:
            path: db/schema.sql
            relativeToChangelogFile: false
  - changeSet:
      id: 2-pgvector-schema
      author: memory-service
      preConditions:
        - onFail: MARK_RAN
        - onError: MARK_RAN
        - dbms:
            type: postgresql
        - sqlCheck:
            expectedResult: 1
            sql: SELECT CASE WHEN EXISTS (SELECT 1 FROM pg_available_extensions WHERE name = 'vector') THEN 1 ELSE 0 END
      changes:
        - sql:
            splitStatements: true
            stripComments: true
            sql: |
              CREATE EXTENSION IF NOT EXISTS vector;
              CREATE TABLE IF NOT EXISTS entry_embeddings (
                  entry_id UUID PRIMARY KEY REFERENCES entries (id) ON DELETE CASCADE,
                  conversation_id UUID NOT NULL REFERENCES conversations (id) ON DELETE CASCADE,
                  embedding vector(256) NOT NULL,
                  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
              );
              CREATE INDEX IF NOT EXISTS idx_entry_embeddings_conversation
                  ON entry_embeddings (conversation_id);
              CREATE INDEX IF NOT EXISTS idx_entry_embeddings_embedding
                  ON entry_embeddings
                  USING ivfflat (embedding vector_cosine_ops)
                  WITH (lists = 100);
  - changeSet:
      id: 3-eviction-indexes
      author: memory-service
      changes:
        - sql:
            splitStatements: true
            sql: |
              CREATE INDEX IF NOT EXISTS idx_conversation_groups_deleted
                  ON conversation_groups (deleted_at) WHERE deleted_at IS NOT NULL;
              CREATE INDEX IF NOT EXISTS idx_conversation_memberships_deleted
                  ON conversation_memberships (deleted_at) WHERE deleted_at IS NOT NULL;
  - changeSet:
      id: 4-rename-memory-epoch-to-epoch
      author: memory-service
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: entries
            columnName: memory_epoch
      changes:
        - renameColumn:
            tableName: entries
            oldColumnName: memory_epoch
            newColumnName: epoch
            columnDataType: BIGINT
        - sql:
            sql: |
              DROP INDEX IF EXISTS idx_entries_conversation_channel_client_epoch_created_at;
              CREATE INDEX IF NOT EXISTS idx_entries_conversation_channel_client_epoch_created_at
                  ON entries (conversation_id, channel, client_id, epoch, created_at);
