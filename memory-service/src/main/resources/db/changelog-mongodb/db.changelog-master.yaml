databaseChangeLog:
  - changeSet:
      id: mongo-1-indexes
      author: memory-service
      comment: Create indexes for efficient queries
      changes:
        - runCommand:
            command: |
              {
                "createIndexes": "entries",
                "indexes": [
                  {
                    "key": { "conversationId": 1, "createdAt": 1 },
                    "name": "idx_entries_conversation_created_at"
                  },
                  {
                    "key": { "conversationGroupId": 1, "createdAt": 1 },
                    "name": "idx_entries_group_created_at"
                  },
                  {
                    "key": { "channel": 1, "indexedContent": 1, "createdAt": 1 },
                    "name": "idx_entries_channel_indexed_created"
                  },
                  {
                    "key": { "indexedContent": 1, "indexedAt": 1 },
                    "name": "idx_entries_indexed_content_at"
                  }
                ]
              }
        - runCommand:
            command: |
              {
                "createIndexes": "conversations",
                "indexes": [
                  {
                    "key": { "conversationGroupId": 1 },
                    "name": "idx_conversations_group"
                  },
                  {
                    "key": { "deletedAt": 1 },
                    "name": "idx_conversations_deleted_at"
                  }
                ]
              }
        - runCommand:
            command: |
              {
                "createIndexes": "conversation_groups",
                "indexes": [
                  {
                    "key": { "deletedAt": 1 },
                    "name": "idx_conversation_groups_deleted_at"
                  }
                ]
              }
        - runCommand:
            command: |
              {
                "createIndexes": "conversation_memberships",
                "indexes": [
                  {
                    "key": { "userId": 1, "conversationGroupId": 1 },
                    "name": "idx_memberships_user_group"
                  },
                  {
                    "key": { "conversationGroupId": 1 },
                    "name": "idx_memberships_group"
                  }
                ]
              }

  - changeSet:
      id: mongo-2-fulltext-search
      author: memory-service
      comment: Add text index on indexedContent for full-text search
      changes:
        - runCommand:
            command: |
              {
                "createIndexes": "entries",
                "indexes": [
                  {
                    "key": { "indexedContent": "text" },
                    "name": "idx_entries_indexed_content_text",
                    "default_language": "english"
                  }
                ]
              }

  - changeSet:
      id: mongo-3-organizations-teams
      author: memory-service
      comment: Create indexes for organizations, teams, and their members
      changes:
        - runCommand:
            command: |
              {
                "createIndexes": "organizations",
                "indexes": [
                  {
                    "key": { "slug": 1 },
                    "name": "idx_organizations_slug",
                    "unique": true
                  },
                  {
                    "key": { "deletedAt": 1 },
                    "name": "idx_organizations_deleted_at"
                  }
                ]
              }
        - runCommand:
            command: |
              {
                "createIndexes": "organization_members",
                "indexes": [
                  {
                    "key": { "organizationId": 1 },
                    "name": "idx_org_members_org"
                  },
                  {
                    "key": { "userId": 1 },
                    "name": "idx_org_members_user"
                  }
                ]
              }
        - runCommand:
            command: |
              {
                "createIndexes": "teams",
                "indexes": [
                  {
                    "key": { "organizationId": 1, "slug": 1 },
                    "name": "idx_teams_org_slug",
                    "unique": true
                  },
                  {
                    "key": { "organizationId": 1 },
                    "name": "idx_teams_organization"
                  },
                  {
                    "key": { "deletedAt": 1 },
                    "name": "idx_teams_deleted_at"
                  }
                ]
              }
        - runCommand:
            command: |
              {
                "createIndexes": "team_members",
                "indexes": [
                  {
                    "key": { "teamId": 1 },
                    "name": "idx_team_members_team"
                  },
                  {
                    "key": { "userId": 1 },
                    "name": "idx_team_members_user"
                  }
                ]
              }
