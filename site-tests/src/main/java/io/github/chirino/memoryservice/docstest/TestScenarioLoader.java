package io.github.chirino.memoryservice.docstest;

import com.fasterxml.jackson.databind.ObjectMapper;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;

/**
 * Loads test scenarios from JSON file generated by Astro build.
 * No MDX parsing needed!
 */
public class TestScenarioLoader {

    // Data classes that match the JSON structure from Astro build
    public static class TestScenarioData {
        public String checkpoint;
        public String sourceFile;
        public List<ScenarioCommand> scenarios;
    }

    public static class ScenarioCommand {
        public String bash;
        public List<Expectation> expectations;
        public List<String> customSteps; // Optional custom Cucumber steps from <Steps> block
    }

    public static class Expectation {
        public String type; // "contains", "not_contains", "status_code"
        public String
                value; // The expected value (String for contains, Integer for status_code will be
        // parsed)
    }

    /**
     * Load all test scenarios from the JSON file generated during site build
     */
    public List<TestScenarioData> loadScenarios(Path jsonFile) throws Exception {
        ObjectMapper mapper = new ObjectMapper();

        String json = Files.readString(jsonFile);
        TestScenarioData[] scenarios = mapper.readValue(json, TestScenarioData[].class);

        return List.of(scenarios);
    }

    /**
     * Load scenarios from default location
     */
    public List<TestScenarioData> loadScenarios() throws Exception {
        Path jsonFile = Path.of("src/test/resources/test-scenarios.json");
        return loadScenarios(jsonFile);
    }
}
