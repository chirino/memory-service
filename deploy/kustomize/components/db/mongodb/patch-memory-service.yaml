apiVersion: apps/v1
kind: Deployment
metadata:
  name: memory-service
spec:
  template:
    spec:
      containers:
        - name: memory-service
          env:
            - name: MEMORY_SERVICE_DATASTORE_TYPE
              value: "mongo"
            - name: QUARKUS_MONGODB_CONNECTION_STRING
              value: "mongodb://mongodb:27017/?directConnection=true"
            - name: QUARKUS_MONGODB_DATABASE
              value: "memory_service"
            - name: QUARKUS_MONGODB_CREDENTIALS_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: MONGO_INITDB_ROOT_USERNAME
            - name: QUARKUS_MONGODB_CREDENTIALS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: MONGO_INITDB_ROOT_PASSWORD
            - name: QUARKUS_MONGODB_CREDENTIALS_AUTH_SOURCE
              value: "admin"
            # Dummy JDBC URL keeps Hibernate ORM's synthetic datasource bean active
            # (prevents InactiveBeanException). Instance<> lazy injection in selectors
            # ensures no actual PostgreSQL connection is ever made.
            - name: QUARKUS_DATASOURCE_JDBC_URL
              value: "jdbc:postgresql://unused:5432/unused"
            - name: QUARKUS_DATASOURCE_JDBC_INITIAL__SIZE
              value: "0"
            - name: QUARKUS_DATASOURCE_JDBC_MIN__SIZE
              value: "0"
            - name: QUARKUS_DATASOURCE_JDBC_MAX__SIZE
              value: "1"
            # Disable PostgreSQL Liquibase â€” migrations route to MongoDB Liquibase
            # via the DatastoreConfigSourceFactory.
            - name: QUARKUS_LIQUIBASE_MIGRATE_AT_START
              value: "false"
            - name: QUARKUS_LIQUIBASE_VALIDATE_ON_MIGRATE
              value: "false"
