apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# Keycloak with its own dedicated PostgreSQL database.
# Independent of the memory-service datastore choice.

resources:
  - deployment-keycloak.yaml
  - deployment-keycloak-db.yaml
  - service-keycloak.yaml
  - service-keycloak-db.yaml
  - pvc-keycloak-db.yaml

configMapGenerator:
  - name: keycloak-realm
    files:
      - memory-service-realm.json
  - name: memory-service-config
    behavior: merge
    literals:
      # KEYCLOAK_FRONTEND_URL and OIDC_TOKEN_ISSUER are read by the chat-quarkus demo app
      # via configMapKeyRef in its deployment â€” not used by the Go memory-service itself.
      - KEYCLOAK_FRONTEND_URL=http://keycloak:8080
      - OIDC_TOKEN_ISSUER=http://keycloak:8080/realms/memory-service
      - MEMORY_SERVICE_OIDC_ISSUER=http://keycloak:8080/realms/memory-service
      - MEMORY_SERVICE_ROLES_ADMIN_OIDC_ROLE=admin
      - MEMORY_SERVICE_ROLES_AUDITOR_OIDC_ROLE=auditor

secretGenerator:
  - name: keycloak-secret
    literals:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KEYCLOAK_CLIENT_SECRET=change-me
  - name: keycloak-db-secret
    literals:
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
      - POSTGRES_DB=keycloak
