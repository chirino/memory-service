apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# Kind-specific patches: nip.io hostnames, local image pull policy,
# and keycloak realm config for local development.
#
# Note: EnvoyProxy is in envoy-gateway-system namespace and is applied
# separately by the kind:init task. The GatewayClass parametersRef patch
# is in each Kind overlay (not here) because kustomize Component patches
# cannot target resources from sibling components.
resources:
  - envoyproxy.yaml

components:
  - ../../../components/gateway-envoy
  - ../../../components/demo/gateway

configMapGenerator:
  - name: keycloak-realm
    files:
      - memory-service-realm.json
    behavior: replace
  - name: memory-service-config
    literals:
      - KEYCLOAK_FRONTEND_URL=http://keycloak.127.0.0.1.nip.io
      - OIDC_TOKEN_ISSUER=http://keycloak.127.0.0.1.nip.io/realms/memory-service
    behavior: replace

patches:
  # Link GatewayClass to the Kind-specific EnvoyProxy (hostNetwork + ClusterIP)
  - target:
      group: gateway.networking.k8s.io
      version: v1
      kind: GatewayClass
      name: eg
    patch: |
      - op: add
        path: /spec/parametersRef
        value:
          group: gateway.envoyproxy.io
          kind: EnvoyProxy
          name: kind-proxy
          namespace: envoy-gateway-system
  # Assign nip.io hostnames to each HTTPRoute
  - target:
      kind: HTTPRoute
      name: demo-chat
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["chat.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: memory-service
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["api.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: keycloak
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["keycloak.127.0.0.1.nip.io"]
      - op: replace
        path: /spec/rules
        value:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            backendRefs:
              - name: keycloak
                port: 8080
  - target:
      kind: HTTPRoute
      name: grafana
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["grafana.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: prometheus
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["prometheus.127.0.0.1.nip.io"]
  # Use IfNotPresent so kind-loaded images aren't pulled from a registry
  - target:
      kind: Deployment
      name: memory-service
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      kind: Deployment
      name: demo-chat
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
