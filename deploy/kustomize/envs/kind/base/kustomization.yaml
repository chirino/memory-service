apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# Kind-specific patches: nip.io hostnames, local image pull policy,
# and keycloak realm config for local development.
#
# Note: EnvoyProxy is in envoy-gateway-system namespace and is applied
# separately by the kind:init task. The GatewayClass parametersRef patch
# is in each Kind overlay (not here) because kustomize Component patches
# cannot target resources from sibling components.
resources:
  - httproute-minio.yaml
  - httproute-minio-api.yaml

components:
  - ../../../components/gateway-envoy
  - ../../../components/demo/gateway
  - ../../../components/storage/minio

configMapGenerator:
  - name: keycloak-realm
    files:
      - memory-service-realm.json
    behavior: replace
  - name: memory-service-config
    behavior: merge
    literals:
      - KEYCLOAK_FRONTEND_URL=http://keycloak.127.0.0.1.nip.io
      - OIDC_TOKEN_ISSUER=http://keycloak.127.0.0.1.nip.io/realms/memory-service
      - QUARKUS_OIDC_AUTH_SERVER_URL=http://keycloak:8080/realms/memory-service
      - QUARKUS_OIDC_TOKEN_ISSUER=http://keycloak.127.0.0.1.nip.io/realms/memory-service
      - MEMORY_SERVICE_ATTACHMENTS_S3_EXTERNAL_ENDPOINT=http://minio-api.127.0.0.1.nip.io

patches:
  # Link GatewayClass to the Kind-specific EnvoyProxy (hostNetwork + ClusterIP)
  - target:
      group: gateway.networking.k8s.io
      version: v1
      kind: GatewayClass
      name: eg
    patch: |
      - op: add
        path: /spec/parametersRef
        value:
          group: gateway.envoyproxy.io
          kind: EnvoyProxy
          name: kind-proxy
          namespace: envoy-gateway-system
  # Assign nip.io hostnames to each HTTPRoute
  - target:
      kind: HTTPRoute
      name: chat-quarkus
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["chat.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: memory-service
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["memory-service.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: keycloak
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["keycloak.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: grafana
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["grafana.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: prometheus
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["prometheus.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: minio
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["minio.127.0.0.1.nip.io"]
  - target:
      kind: HTTPRoute
      name: minio-api
    patch: |
      - op: add
        path: /spec/hostnames
        value: ["minio-api.127.0.0.1.nip.io"]
  # Use IfNotPresent so kind-loaded images aren't pulled from a registry
  - target:
      kind: Deployment
      name: memory-service
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      kind: Deployment
      name: chat-quarkus
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      kind: Deployment
      name: minio
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
