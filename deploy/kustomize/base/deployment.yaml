apiVersion: apps/v1
kind: Deployment
metadata:
  name: memory-service
  labels:
    app: memory-service
    app.kubernetes.io/name: memory-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: memory-service
  template:
    metadata:
      labels:
        app: memory-service
        app.kubernetes.io/name: memory-service
    spec:
      serviceAccountName: memory-service
      containers:
        - name: memory-service
          image: ghcr.io/chirino/memory-service:latest
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: management
              containerPort: 8085
              protocol: TCP
          # Environment variables are loaded from a ConfigMap (non-secret
          # values) and a Secret (credentials, API keys). Both are optional;
          # missing keys are simply unset. Component patches can override
          # specific values by adding entries to the env list below (env
          # takes precedence over envFrom).
          #
          # Available ConfigMap keys (see docs/configuration for details):
          #
          # Server:       MEMORY_SERVICE_PORT, MEMORY_SERVICE_PLAIN_TEXT, MEMORY_SERVICE_TLS,
          #               MEMORY_SERVICE_MANAGEMENT_PORT, MEMORY_SERVICE_TEMP_DIR
          # DB:           MEMORY_SERVICE_DB_KIND, MEMORY_SERVICE_DB_MIGRATE_AT_START,
          #               MEMORY_SERVICE_DB_MAX_OPEN_CONNS, MEMORY_SERVICE_DB_MAX_IDLE_CONNS
          # Cache:        MEMORY_SERVICE_CACHE_KIND, MEMORY_SERVICE_CACHE_EPOCH_TTL,
          #               MEMORY_SERVICE_CACHE_REDIS_CLIENT
          # Resumer:      MEMORY_SERVICE_RESPONSE_RESUMER_TEMP_FILE_RETENTION
          # Redis:        MEMORY_SERVICE_REDIS_HOSTS
          # Infinispan:   MEMORY_SERVICE_INFINISPAN_HOST
          # Vector:       MEMORY_SERVICE_VECTOR_KIND, MEMORY_SERVICE_VECTOR_MIGRATE_AT_START
          # Embedding:    MEMORY_SERVICE_EMBEDDING_KIND
          # Attachments:  MEMORY_SERVICE_ATTACHMENTS_KIND, MEMORY_SERVICE_ATTACHMENTS_MAX_SIZE,
          #               MEMORY_SERVICE_ATTACHMENTS_DEFAULT_EXPIRES_IN, MEMORY_SERVICE_ATTACHMENTS_MAX_EXPIRES_IN,
          #               MEMORY_SERVICE_ATTACHMENTS_CLEANUP_INTERVAL,
          #               MEMORY_SERVICE_ATTACHMENTS_DOWNLOAD_URL_EXPIRES_IN,
          #               MEMORY_SERVICE_ATTACHMENTS_S3_BUCKET
          # OIDC:         MEMORY_SERVICE_OIDC_ISSUER, MEMORY_SERVICE_OIDC_DISCOVERY_URL
          # Roles:        MEMORY_SERVICE_ROLES_ADMIN_OIDC_ROLE, MEMORY_SERVICE_ROLES_AUDITOR_OIDC_ROLE,
          #               MEMORY_SERVICE_ROLES_INDEXER_OIDC_ROLE, MEMORY_SERVICE_ROLES_ADMIN_USERS,
          #               MEMORY_SERVICE_ROLES_AUDITOR_USERS, MEMORY_SERVICE_ROLES_INDEXER_USERS,
          #               MEMORY_SERVICE_ROLES_ADMIN_CLIENTS, MEMORY_SERVICE_ROLES_AUDITOR_CLIENTS,
          #               MEMORY_SERVICE_ROLES_INDEXER_CLIENTS
          # Admin:        MEMORY_SERVICE_ADMIN_REQUIRE_JUSTIFICATION
          # CORS:         MEMORY_SERVICE_CORS_ENABLED, MEMORY_SERVICE_CORS_ORIGINS
          # Monitoring:   MEMORY_SERVICE_PROMETHEUS_URL
          #
          # Available Secret keys:
          #
          # DB:           MEMORY_SERVICE_DB_URL
          # Infinispan:   MEMORY_SERVICE_INFINISPAN_USERNAME, MEMORY_SERVICE_INFINISPAN_PASSWORD
          # OpenAI:       MEMORY_SERVICE_EMBEDDING_OPENAI_API_KEY
          # API keys:     MEMORY_SERVICE_API_KEYS_<CLIENT_ID> (one per client)
          envFrom:
            - configMapRef:
                name: memory-service-config
                optional: true
            - secretRef:
                name: memory-service-secret
                optional: true
          env:
            # Kubernetes auto-injects MEMORY_SERVICE_PORT=tcp://<clusterIP>:8080 as a service
            # discovery env var (for the memory-service Service). Explicitly override it here
            # so the Go server receives an integer, not a TCP URL.
            - name: MEMORY_SERVICE_PORT
              value: "8080"
          livenessProbe:
            httpGet:
              path: /health
              port: management
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: management
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              memory: 256Mi
              cpu: 250m
            limits:
              memory: 1Gi
              cpu: "1"
