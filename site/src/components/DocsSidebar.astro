---
const basePath = import.meta.env.BASE_URL;
const currentPath = Astro.url.pathname;

interface NavItem {
  label: string;
  href: string;
  items?: NavItem[]; // Support 3rd level nesting
}

interface NavSection {
  title: string;
  href?: string;
  collapsible?: boolean;
  items: NavItem[];
}

const navigation: NavSection[] = [
  {
    title: 'Getting Started',
    items: [
      { label: 'Overview', href: '/docs/' },
      { label: 'Quick Start', href: '/docs/getting-started/' },
      { label: 'Service Configuration', href: '/docs/configuration/' },
    ],
  },
  {
    title: 'Core Concepts',
    href: '/docs/concepts/',
    collapsible: true,
    items: [
      { label: 'Conversations', href: '/docs/concepts/conversations/' },
      { label: 'Entries', href: '/docs/concepts/entries/' },
      { label: 'Forking', href: '/docs/concepts/forking/' },
      { label: 'Indexing & Search', href: '/docs/concepts/indexing-and-search/' },
      { label: 'Sharing & Access Control', href: '/docs/concepts/sharing/' },
    ],
  },
  {
    title: 'Quarkus',
    href: '/docs/quarkus/',
    collapsible: true,
    items: [
      { label: 'Getting Started', href: '/docs/quarkus/getting-started/' },
      { label: 'Conversation History', href: '/docs/quarkus/conversation-history/' },
      { label: 'Indexing and Search', href: '/docs/quarkus/indexing-and-search/' },
      { label: 'Conversation Forking', href: '/docs/quarkus/conversation-forking/' },
      { label: 'Response Resumption', href: '/docs/quarkus/response-resumption/' },
      { label: 'Conversation Sharing', href: '/docs/quarkus/sharing/' },
      { label: 'Dev Services', href: '/docs/quarkus/dev-services/' },
      // { label: 'Overview', href: '/docs/quarkus/overview/' },
      // { label: 'REST Client', href: '/docs/quarkus/rest-client/' },
      // { label: 'gRPC Client', href: '/docs/quarkus/grpc-client/' },
      // { label: 'LangChain4j', href: '/docs/quarkus/langchain4j/' },
    ],
  },
  {
    title: 'Spring',
    href: '/docs/spring/',
    collapsible: true,
    items: [
      { label: 'Getting Started', href: '/docs/spring/getting-started/' },
      { label: 'Conversation History', href: '/docs/spring/conversation-history/' },
      { label: 'Indexing and Search', href: '/docs/spring/indexing-and-search/' },
      { label: 'Conversation Forking', href: '/docs/spring/conversation-forking/' },
      { label: 'Response Resumption', href: '/docs/spring/response-resumption/' },
      { label: 'Conversation Sharing', href: '/docs/spring/sharing/' },
      { label: 'Docker Compose', href: '/docs/spring/docker-compose/' },
    ],
  },
  // {
  //   title: 'Deployment',
  //   items: [
  //     { label: 'Docker', href: '/docs/deployment/docker/' },
  //     { label: 'Kubernetes', href: '/docs/deployment/kubernetes/' },
  //     { label: 'Database Setup', href: '/docs/deployment/databases/' },
  //   ],
  // },
  {
    title: 'Reference',
    items: [
      { label: 'API Contracts', href: '/docs/api-contracts/' },
      { label: 'FAQ', href: '/docs/faq/' },
      { label: 'Changelog', href: '/docs/changelog/' },
      { label: 'Versions', href: '/docs/versions/' },
    ],
  },
];

function getFullHref(href: string) {
  return basePath + href.slice(1);
}

function isActive(href: string) {
  const fullHref = getFullHref(href);
  // Exact match for root docs page
  if (href === '/docs/') {
    return currentPath === fullHref || currentPath === fullHref.slice(0, -1);
  }
  // Prefix match for others
  return currentPath.startsWith(fullHref);
}

function isExactActive(href: string) {
  const fullHref = getFullHref(href);
  return currentPath === fullHref || currentPath === fullHref.slice(0, -1);
}

function isSectionExpanded(section: NavSection) {
  if (!section.collapsible) return true;
  if (section.href && isActive(section.href)) return true;
  return section.items.some(item => isActive(item.href));
}
---

<nav class="px-4 pb-8" aria-label="Documentation navigation">
  {navigation.map(section => (
    <div class:list={['sidebar-section', section.collapsible && 'sidebar-section-collapsible', section.collapsible && !isSectionExpanded(section) && 'sidebar-section-collapsed']}>
      {section.href ? (
        <a href={getFullHref(section.href)} class:list={['sidebar-heading', section.collapsible && 'sidebar-heading-collapsible', isExactActive(section.href) && 'sidebar-heading-active', isSectionExpanded(section) && 'mb-2']}>
          {section.collapsible && (
            <svg class:list={['sidebar-chevron', isSectionExpanded(section) && 'sidebar-chevron-expanded']} viewBox="0 0 16 16" fill="currentColor">
              <path d="M6.22 4.22a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.75.75 0 0 1-1.06-1.06L8.94 8 6.22 5.28a.75.75 0 0 1 0-1.06Z" />
            </svg>
          )}
          <h3>{section.title}</h3>
        </a>
      ) : (
        <h3 class="sidebar-heading mb-2">{section.title}</h3>
      )}
      {isSectionExpanded(section) && (
        <ul class:list={['space-y-1', section.collapsible && 'sidebar-items-indented']}>
          {section.items.map(item => (
            <li>
              <a
                href={getFullHref(item.href)}
                class:list={[
                  'sidebar-link',
                  isActive(item.href) && 'sidebar-link-active',
                ]}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.label}
              </a>
              {item.items && (
                <ul class="space-y-1 mt-1">
                  {item.items.map(subItem => (
                    <li>
                      <a
                        href={getFullHref(subItem.href)}
                        class:list={[
                          'sidebar-link sidebar-link-nested',
                          isActive(subItem.href) && 'sidebar-link-active',
                        ]}
                        aria-current={isActive(subItem.href) ? 'page' : undefined}
                      >
                        {subItem.label}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  ))}
</nav>
