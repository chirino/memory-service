---
layout: ../../../layouts/DocsLayout.astro
title: Conversation Sharing
description: Learn how to share conversations with other users and manage access control in your Spring Boot application
---
import CodeFromFile from '../../../components/CodeFromFile.astro';
import TestScenario from '../../../components/TestScenario.astro';
import CurlTest from '../../../components/CurlTest.astro';

# Conversation Sharing

This guide shows you how to implement conversation sharing and ownership transfer features in your Spring Boot application using the Memory Service.

> **ðŸ’¡ New to sharing concepts?**
> Read [Sharing & Access Control](/docs/concepts/sharing/) first to understand access levels, membership management, and ownership transfers. This guide focuses on the Spring Boot implementation.

## Prerequisites

**Starting checkpoint**: This guide starts from [spring/examples/doc-checkpoints/05-response-resumption](https://github.com/chirino/memory-service/tree/main/spring/examples/doc-checkpoints/05-response-resumption)

Make sure you've completed the previous guides:
- [Conversation Forking](/docs/spring/conversation-forking/) - Branching conversations
- [Response Resumption](/docs/spring/response-resumption/) - Streaming with resume support
- Multiple test users in Keycloak (bob, alice, charlie)

## Membership Endpoints

Add the membership endpoints to your `MemoryServiceProxyController`:

<CodeFromFile
  file="spring/examples/doc-checkpoints/06-sharing/src/main/java/com/example/demo/MemoryServiceProxyController.java"
  lang="java"
  before={1}
  after={23}
>// Membership management endpoints</CodeFromFile>

## Ownership Transfer Endpoints

Create a new `OwnershipTransfersController`:

<CodeFromFile
  file="spring/examples/doc-checkpoints/06-sharing/src/main/java/com/example/demo/OwnershipTransfersController.java"
  lang="java"
/>

## Testing Membership Management

### Setting Up Helper Functions

First, create a helper function to get access tokens for different users:

```bash
# Get access token for a user
function get-token() {
  local username=${1:-bob}
  local password=${2:-$username}
  curl -sSfX POST http://localhost:8081/realms/memory-service/protocol/openid-connect/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=memory-service-client" \
    -d "client_secret=change-me" \
    -d "grant_type=password" \
    -d "username=$username" \
    -d "password=$password" \
    | jq -r '.access_token'
}
```

<TestScenario checkpoint="spring/examples/doc-checkpoints/06-sharing">

First, create a conversation as bob so the membership endpoints have data to work with:

<CurlTest steps={`
Then the response status should be 200
`}>

```bash
curl -sSfX POST http://localhost:9090/chat/381ca8a4-7ade-4f45-a9dd-6f5d71a30292 \
  -H "Content-Type: text/plain" \
  -H "Authorization: Bearer $(get-token)" \
  -d "Hello, starting a conversation for sharing tests."
```

</CurlTest>

### List Members

<CurlTest steps={`
Then the response status should be 200
And the response body should be json:
"""
{
  "data": [
    {
      "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
      "userId": "bob",
      "accessLevel": "owner",
      "createdAt": "%{response.body.data[0].createdAt}"
    }
  ]
}
"""
`}>

```bash
# As bob (owner), list members of the conversation
curl -sSfX GET http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292/memberships \
  -H "Authorization: Bearer $(get-token bob bob)" | jq
```

</CurlTest>

Example response:

```json
{
  "data": [
    {
      "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
      "userId": "bob",
      "accessLevel": "owner",
      "createdAt": "2025-01-10T14:32:05Z"
    }
  ]
}
```

### Add a Member

<CurlTest steps={`
Then the response status should be 201
And the response body should be json:
"""
{
  "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
  "userId": "alice",
  "accessLevel": "writer",
  "createdAt": "%{response.body.createdAt}"
}
"""
`}>

```bash
# Share conversation with alice as a writer
curl -sSfX POST http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292/memberships \
  -H "Authorization: Bearer $(get-token bob bob)" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "alice",
    "accessLevel": "writer"
  }' | jq
```

</CurlTest>

Example response:

```json
{
  "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
  "userId": "alice",
  "accessLevel": "writer",
  "createdAt": "2025-01-10T14:33:15Z"
}
```

Alice can now read and write to the conversation:

<CurlTest steps={`
Then the response status should be 200
`}>

```bash
curl -sSfX POST http://localhost:9090/chat/381ca8a4-7ade-4f45-a9dd-6f5d71a30292 \
  -H "Authorization: Bearer $(get-token alice alice)" \
  -H "Content-Type: text/plain" \
  -d "Hi from Alice!"
```

</CurlTest>

</TestScenario>

### Update Access Level

```bash
# Promote alice from writer to manager
curl -sSfX PATCH http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292/memberships/alice \
  -H "Authorization: Bearer $(get-token bob bob)" \
  -H "Content-Type: application/json" \
  -d '{
    "accessLevel": "manager"
  }' | jq
```

Example response:

```json
{
  "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
  "userId": "alice",
  "accessLevel": "manager",
  "createdAt": "2025-01-10T14:33:15Z"
}
```

Now alice can share with others (but only assign writer/reader levels):

```bash
curl -sSfX POST http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292/memberships \
  -H "Authorization: Bearer $(get-token alice alice)" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "charlie",
    "accessLevel": "reader"
  }' | jq
```

Example response:

```json
{
  "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
  "userId": "charlie",
  "accessLevel": "reader",
  "createdAt": "2025-01-10T14:34:00Z"
}
```

### Remove a Member

```bash
# Remove charlie from the conversation
curl -sSfX DELETE http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292/memberships/charlie \
  -H "Authorization: Bearer $(get-token bob bob)"
```

Returns `204 No Content` on success. Charlie can no longer access the conversation:

```bash
curl -sSf GET http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292 \
  -H "Authorization: Bearer $(get-token charlie charlie)"
```

Returns `403 Forbidden`.

## Testing Ownership Transfers

### Initiate a Transfer

```bash
# Bob (owner) wants to transfer ownership to alice
curl -sSfX POST http://localhost:9090/v1/ownership-transfers \
  -H "Authorization: Bearer $(get-token bob bob)" \
  -H "Content-Type: application/json" \
  -d '{
    "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
    "newOwnerUserId": "alice"
  }' | jq
```

Example response:

```json
{
  "id": "f3a8b2c1-1234-5678-9abc-def012345678",
  "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
  "fromUserId": "bob",
  "toUserId": "alice",
  "createdAt": "2025-02-08T10:30:00Z"
}
```

### List Pending Transfers

```bash
# Alice sees transfers where she is the recipient
curl -sSfX GET "http://localhost:9090/v1/ownership-transfers?role=recipient" \
  -H "Authorization: Bearer $(get-token alice alice)" | jq
```

Example response:

```json
{
  "data": [
    {
      "id": "f3a8b2c1-1234-5678-9abc-def012345678",
      "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
      "fromUserId": "bob",
      "toUserId": "alice",
      "createdAt": "2025-02-08T10:30:00Z"
    }
  ]
}
```

Other role filters:

```bash
# Bob sees transfers where he is the sender
curl -sSfX GET "http://localhost:9090/v1/ownership-transfers?role=sender" \
  -H "Authorization: Bearer $(get-token bob bob)" | jq

# List all (sent or received)
curl -sSfX GET "http://localhost:9090/v1/ownership-transfers?role=all" \
  -H "Authorization: Bearer $(get-token alice alice)" | jq
```

### Accept a Transfer

```bash
# Alice accepts the transfer (use the transfer ID from the create response)
TRANSFER_ID="f3a8b2c1-1234-5678-9abc-def012345678"
curl -sSfX POST http://localhost:9090/v1/ownership-transfers/$TRANSFER_ID/accept \
  -H "Authorization: Bearer $(get-token alice alice)"
```

Returns `204 No Content` on success. Verify the new membership state:

```bash
curl -sSfX GET http://localhost:9090/v1/conversations/381ca8a4-7ade-4f45-a9dd-6f5d71a30292/memberships \
  -H "Authorization: Bearer $(get-token alice alice)" | jq
```

Example response:

```json
{
  "data": [
    {
      "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
      "userId": "alice",
      "accessLevel": "owner",
      "createdAt": "2025-01-10T14:33:15Z"
    },
    {
      "conversationId": "381ca8a4-7ade-4f45-a9dd-6f5d71a30292",
      "userId": "bob",
      "accessLevel": "manager",
      "createdAt": "2025-01-10T14:32:05Z"
    }
  ]
}
```

Alice is now the owner. Bob was automatically demoted to manager.

### Decline/Cancel a Transfer

```bash
# Alice can decline the transfer (or bob can cancel it)
TRANSFER_ID="f3a8b2c1-1234-5678-9abc-def012345678"
curl -sSfX DELETE http://localhost:9090/v1/ownership-transfers/$TRANSFER_ID \
  -H "Authorization: Bearer $(get-token alice alice)"
```

Returns `204 No Content`. The transfer is deleted and ownership remains unchanged.

## Completed Checkpoint

**Completed code**: View the full implementation at [spring/examples/doc-checkpoints/06-sharing](https://github.com/chirino/memory-service/tree/main/spring/examples/doc-checkpoints/06-sharing)

## What's Next

You've now learned how to:
- Share conversations with different access levels
- Manage conversation memberships
- Transfer ownership between users
- Build collaborative applications with proper access control

For a production-ready example with a frontend, see the [chat-spring example](https://github.com/chirino/memory-service/tree/main/spring/examples/chat-spring).
