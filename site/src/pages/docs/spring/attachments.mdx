---
layout: ../../../layouts/DocsLayout.astro
title: Attachments
description: Proxy attachment upload, download, and management APIs from your agent app.
---
import { Code } from 'astro:components';
import { PROJECT_VERSION } from '../../../config';
import CodeFromFile from '../../../components/CodeFromFile.astro';
import TestScenario from '../../../components/TestScenario.astro';
import CurlTest from '../../../components/CurlTest.astro';

This guide covers proxying attachment operations — upload, download, signed URLs, and deletion — from your agent app to the Memory Service.

> **New to attachment concepts?**
> Read [Attachments](/docs/concepts/attachments/) first to understand the attachment lifecycle, external URL references vs server-stored files, and how attachments link to conversation entries. This guide focuses on the Spring implementation.

## Prerequisites

**Starting checkpoint**: This guide starts from [spring/examples/doc-checkpoints/03-with-history](https://github.com/chirino/memory-service/tree/main/spring/examples/doc-checkpoints/03-with-history)

Make sure you've completed the previous guides:
- [Getting Started](/docs/spring/getting-started/) - Basic memory service integration
- [Conversation History](/docs/spring/conversation-history/) - History recording and APIs

## Why Proxy Attachments?

Agent apps mediate all interactions between end users and the Memory Service. Your frontend cannot call the Memory Service directly — it sends requests to your agent app, which forwards them with proper authentication.

The `MemoryServiceProxy` helper already handles the complexity of multipart uploads, binary downloads, redirect handling, and bearer token propagation for attachments. You just need to create thin controllers that delegate to it:

- **`AttachmentsProxyController`** — Authenticated proxy for upload, download, download-url, and delete
- **`AttachmentDownloadProxyController`** — Unauthenticated proxy for signed download URLs (used by browser `<img>`, `<audio>`, `<video>` tags)

## Add Attachment Proxy Endpoints

Create `AttachmentsProxyController.java` to proxy authenticated attachment operations to the Memory Service:

<CodeFromFile
  file="spring/examples/doc-checkpoints/08-with-attachments/src/main/java/com/example/demo/AttachmentsProxyController.java"
  lang="java"
/>

Each method is a one-liner delegation to `MemoryServiceProxy`, which handles:

- **WebClient streaming** — Uses Spring's `WebClient` with `exchangeToMono` for full control over the response, avoiding buffering large files in memory.
- **Bearer token propagation** — Extracts the user's bearer token and forwards it to the Memory Service for authorization.
- **Redirect handling** — The `retrieveAttachment()` method handles 302 redirects for S3 presigned URLs.
- **Multipart upload** — Uses `BodyInserters.fromMultipartData()` with an `InputStreamResource` to stream the file through without loading it entirely into memory.

## Add Signed Download Proxy

Browser elements like `<img>`, `<audio>`, and `<video>` tags cannot send Authorization headers. The Memory Service solves this with signed download URLs that embed a time-limited token in the URL path. This proxy forwards those unauthenticated requests.

Create `AttachmentDownloadProxyController.java`:

<CodeFromFile
  file="spring/examples/doc-checkpoints/08-with-attachments/src/main/java/com/example/demo/AttachmentDownloadProxyController.java"
  lang="java"
/>

This endpoint requires no bearer token — the signed token in the URL path provides authorization.

## Update Security Configuration

Update `SecurityConfig.java` to allow unauthenticated access to the signed download path:

<CodeFromFile
  file="spring/examples/doc-checkpoints/08-with-attachments/src/main/java/com/example/demo/SecurityConfig.java"
  lang="java"
/>

The key change is adding `.requestMatchers("/v1/attachments/download/**").permitAll()` before `.anyRequest().authenticated()`. This allows signed download URLs to work without an Authorization header, while all other endpoints still require authentication.

<TestScenario checkpoint="spring/examples/doc-checkpoints/08-with-attachments">

## Testing

Make sure you define the bearer token helper:

```bash
function get-token() {
  curl -sSfX POST http://localhost:8081/realms/memory-service/protocol/openid-connect/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=memory-service-client" \
    -d "client_secret=change-me" \
    -d "grant_type=password" \
    -d "username=bob" \
    -d "password=bob" \
    | jq -r '.access_token'
}
```

### Upload an Attachment

<CurlTest steps={`
Then the response status should be 201
And set "ATTACHMENT_ID" to the json response field "id"
And the response body should be json:
"""
{
  "id": "%{response.body.id}",
  "href": "%{response.body.href}",
  "contentType": "text/plain",
  "filename": "test-upload.txt",
  "size": %{response.body.size},
  "sha256": "%{response.body.sha256}",
  "expiresAt": "%{response.body.expiresAt}",
  "status": "ready"
}
"""
`}>

```bash
echo "Hello, attachments!" > /tmp/test-upload.txt
curl -sSfX POST http://localhost:9090/v1/attachments \
  -H "Authorization: Bearer $(get-token)" \
  -F "file=@/tmp/test-upload.txt" | jq
```

</CurlTest>

Example response:

```json
{
  "id": "96618a21-c7fc-41c6-ba71-b1d83e3ecb95",
  "href": "/v1/attachments/96618a21-c7fc-41c6-ba71-b1d83e3ecb95",
  "contentType": "text/plain",
  "filename": "test-upload.txt",
  "size": 21,
  "sha256": "a1b2c3d4...",
  "expiresAt": "2025-01-28T11:30:00Z",
  "status": "ready"
}
```

Save the attachment ID for subsequent commands:

```bash
ATTACHMENT_ID="<id from the response above>"
```

### Get a Signed Download URL

<CurlTest steps={`
Then the response status should be 200
And set "DOWNLOAD_URL" to the json response field "url"
And the response body should be json:
"""
{
  "url": "%{response.body.url}",
  "expiresIn": %{response.body.expiresIn}
}
"""
`}>

```bash
curl -sSfX GET "http://localhost:9090/v1/attachments/${ATTACHMENT_ID}/download-url" \
  -H "Authorization: Bearer $(get-token)" | jq
```

</CurlTest>

Example response:

```json
{
  "url": "/v1/attachments/download/dG9rZW4.../test-upload.txt",
  "expiresIn": 300
}
```

### Download via Signed URL (No Auth Required)

Use the `url` from the previous response — no Authorization header needed:

<CurlTest steps={`
Then the response status should be 200
And the response body should be text:
"""
Hello, attachments!
"""
`}>

```bash
curl -sSf "http://localhost:9090${DOWNLOAD_URL}"
```

</CurlTest>

### Delete an Attachment

<CurlTest steps={`
Then the response status should be 204
`}>

```bash
curl -sSfX DELETE "http://localhost:9090/v1/attachments/${ATTACHMENT_ID}" \
  -H "Authorization: Bearer $(get-token)"
```

</CurlTest>

</TestScenario>

## Next Steps

- [Conversation Forking](/docs/spring/conversation-forking/) — Branch conversations to explore alternative paths
- [Response Resumption](/docs/spring/response-resumption/) — Streaming responses with resume and cancel support
- [Conversation Sharing](/docs/spring/sharing/) — Share conversations with other users
