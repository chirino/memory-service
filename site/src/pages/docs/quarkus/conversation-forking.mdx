---
layout: ../../../layouts/DocsLayout.astro
title: Conversation Forking
description: Branch conversations to explore alternative paths.
---
import CodeFromFile from '../../../components/CodeFromFile.astro';
import TestScenario from '../../../components/TestScenario.astro';
import CurlTest from '../../../components/CurlTest.astro';

This guide covers conversation forking â€” letting users branch off from any point in a conversation to explore alternative paths.

> **New to forking concepts?**
> Read [Forking](/docs/concepts/forking/) first to understand how conversation forking works. This guide focuses on the Quarkus implementation.

## Prerequisites

**Starting checkpoint**: This guide starts from [quarkus/examples/doc-checkpoints/03-with-history](https://github.com/chirino/memory-service/tree/main/quarkus/examples/doc-checkpoints/03-with-history)

Make sure you've completed the previous guides:
- [Getting Started](/docs/quarkus/getting-started/) - Basic memory service integration
- [Conversation History](/docs/quarkus/conversation-history/) - History recording and APIs

## Conversation Forking

### How Forking Works

Forks are created implicitly when the first entry is appended to a new conversation with fork metadata. In this checkpoint, `HistoryRecordingAgent` remains the same as the previous step, and fork metadata is passed when creating entries through the Memory Service API:

<CodeFromFile
  file="quarkus/examples/doc-checkpoints/04-conversation-forking/src/main/java/org/acme/HistoryRecordingAgent.java"
  lang="java"
/>

**Why**: Forking is initiated at the history entry level, not at the agent level. When the first entry in a new conversation includes `forkedAtConversationId` and `forkedAtEntryId` fields, the Memory Service automatically establishes the fork relationship and replays the parent conversation's memory up to the fork point.

### Listing Forks

Add this method to `ConversationsResource.java` to list forks for a conversation:

<CodeFromFile
  file="quarkus/examples/doc-checkpoints/04-conversation-forking/src/main/java/org/acme/ConversationsResource.java"
  lang="java"
  before={2}
  after={1}
>public Response listConversationForks</CodeFromFile>

**What changed**: Added a `listConversationForks` endpoint at `GET /{conversationId}/forks` that calls `proxy.listConversationForks`. **Why**: Frontends need to discover all branches stemming from a conversation so users can navigate between them. The endpoint returns the root conversation and all its forks in a flat list, each annotated with its `forkedAtConversationId` so the UI can reconstruct the branch tree.

## Try It With Curl

<TestScenario checkpoint="quarkus/examples/doc-checkpoints/04-conversation-forking">

Define a helper to get a bearer token for `bob`:

```bash
function get-token() {
  curl -sSfX POST http://localhost:8081/realms/memory-service/protocol/openid-connect/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=memory-service-client" \
    -d "client_secret=change-me" \
    -d "grant_type=password" \
    -d "username=bob" \
    -d "password=bob" \
    | jq -r '.access_token'
}
```

Create a turn on the source conversation:

<CurlTest steps={`
Then the response status should be 200
`}>

```bash
curl -NsSfX POST http://localhost:9090/chat/88a1db4c-ce91-4391-a6c1-baf9bcc65a86 \
  -H "Content-Type: text/plain" \
  -H "Authorization: Bearer $(get-token)" \
  -d "Hello from the root conversation."
```

</CurlTest>

Example response:

```text
Sure, I can help with that.
```

Fetch the entry id to fork from:

<CurlTest steps={`
Then the response status should be 200
And set "FORK_ENTRY_ID" to the json response field "data[1].id"
`}>

```bash
curl -sSfX GET http://localhost:9090/v1/conversations/88a1db4c-ce91-4391-a6c1-baf9bcc65a86/entries \
  -H "Authorization: Bearer $(get-token)" | jq
```

</CurlTest>

Example response from the entries API:

```json
{
  "data": [
    {
      "id": "2a9c8fd3-c11a-4b12-9a7f-43fd6d580034",
      "conversationId": "88a1db4c-ce91-4391-a6c1-baf9bcc65a86",
      "channel": "history",
      "contentType": "history",
      "content": [{"role": "USER", "text": "Hello from the root conversation."}]
    }
  ]
}
```

Create a forked entry (this uses the Memory Service API directly so fork metadata can be passed in the request body).
Use a different conversation ID in the path (`d517e108-28f0-49a1-93cc-d0f48ebedf42` below) than the root conversation ID:

<CurlTest steps={`
Then the response status should be 201
`}>

```bash
curl -sSfX POST http://localhost:8082/v1/conversations/d517e108-28f0-49a1-93cc-d0f48ebedf42/entries \
  -H "Authorization: Bearer $(get-token)" \
  -H "X-API-Key: agent-api-key-1" \
  -H "Content-Type: application/json" \
  -d '{
    "channel": "history",
    "contentType": "history",
    "content": [{"role": "USER", "text": "Continue from this fork."}],
    "forkedAtConversationId": "88a1db4c-ce91-4391-a6c1-baf9bcc65a86",
    "forkedAtEntryId": "${FORK_ENTRY_ID}"
  }' | jq
```

</CurlTest>

Example response:

```json
{
  "id": "3eefa9b1-8d2c-449a-8d07-6b2d670b453a",
  "conversationId": "d517e108-28f0-49a1-93cc-d0f48ebedf42",
  "channel": "history",
  "contentType": "history",
  "content": [{"role": "USER", "text": "Continue from this fork."}]
}
```

List forks for the source conversation through the Quarkus proxy endpoint:

<CurlTest steps={`
Then the response status should be 200
And the response should contain "88a1db4c-ce91-4391-a6c1-baf9bcc65a86"
And the response should contain "d517e108-28f0-49a1-93cc-d0f48ebedf42"
`}>

```bash
curl -sSfX GET http://localhost:9090/v1/conversations/88a1db4c-ce91-4391-a6c1-baf9bcc65a86/forks \
  -H "Authorization: Bearer $(get-token)" | jq
```

</CurlTest>

Example response:

```json
{
  "data": [
    {
      "conversationId": "88a1db4c-ce91-4391-a6c1-baf9bcc65a86",
      "title": "Hello from the root conversation.",
      "createdAt": "2026-02-23T03:56:55.880524Z"
    },
    {
      "conversationId": "d517e108-28f0-49a1-93cc-d0f48ebedf42",
      "forkedAtConversationId": "88a1db4c-ce91-4391-a6c1-baf9bcc65a86",
      "title": "Continue from this fork.",
      "createdAt": "2026-02-23T03:57:31.598799Z"
    }
  ],
  "afterCursor": null
}
```

</TestScenario>

## Next Steps

- [Response Resumption](/docs/quarkus/response-resumption/) - Streaming responses with resume and cancel support.
- [Conversation Sharing](/docs/quarkus/sharing/) - Share conversations with other users.
- [Dev Services](/docs/quarkus/dev-services/) - Automatic memory-service container startup for development and testing.
