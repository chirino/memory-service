---
layout: ../../../layouts/DocsLayout.astro
title: Conversation Sharing
description: Learn how to share conversations with other users and manage access control in your Quarkus application
---
import CodeFromFile from '../../../components/CodeFromFile.astro';
import TestScenario from '../../../components/TestScenario.astro';
import CurlTest from '../../../components/CurlTest.astro';

# Conversation Sharing

This guide shows you how to implement conversation sharing and ownership transfer features in your Quarkus application using the Memory Service.

> **ðŸ’¡ New to sharing concepts?**
> Read [Sharing & Access Control](/docs/concepts/sharing/) first to understand access levels, membership management, and ownership transfers. This guide focuses on the Quarkus implementation.

## Prerequisites

**Starting checkpoint**: This guide starts from [quarkus/examples/doc-checkpoints/05-response-resumption](https://github.com/chirino/memory-service/tree/main/quarkus/examples/doc-checkpoints/05-response-resumption)

Make sure you've completed the previous guides:
- [Conversation Forking](/docs/quarkus/conversation-forking/) - Branching conversations
- [Response Resumption](/docs/quarkus/response-resumption/) - Streaming with resume support
- Multiple test users in Keycloak (bob, alice, charlie)

## Membership Endpoints

Add the membership endpoints to your `ConversationsResource`:

<CodeFromFile
  file="quarkus/examples/doc-checkpoints/06-sharing/src/main/java/org/acme/ConversationsResource.java"
  lang="java"
  before={0}
  after={35}
>// Membership management endpoints</CodeFromFile>

**Why**: These endpoints let your frontend implement a sharing UI without directly exposing the Memory Service. The proxy pattern ensures that all calls carry both the service account API key (for Memory Service authentication) and the caller's Bearer token (for authorization checks), so users can only manage memberships on conversations they own or manage.

## Ownership Transfer Endpoints

Create a new `OwnershipTransfersResource`:

<CodeFromFile
  file="quarkus/examples/doc-checkpoints/06-sharing/src/main/java/org/acme/OwnershipTransfersResource.java"
  lang="java"
/>

**Why**: Ownership transfer is a two-step process â€” the current owner initiates it and the recipient must explicitly accept. Keeping this in its own resource class separates membership management (granting access) from ownership transfer (changing who is ultimately responsible for a conversation), making each concern easier to reason about and audit.

## Testing Membership Management

### Setting Up Helper Functions

First, create a helper function to get access tokens for different users:

```bash
# Get access token for a user
function get-token() {
  local username=${1:-bob}
  local password=${2:-$username}
  curl -sSfX POST http://localhost:8081/realms/memory-service/protocol/openid-connect/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=memory-service-client" \
    -d "client_secret=change-me" \
    -d "grant_type=password" \
    -d "username=$username" \
    -d "password=$password" \
    | jq -r '.access_token'
}
```

<TestScenario checkpoint="quarkus/examples/doc-checkpoints/06-sharing">

First, create a conversation as bob so the membership endpoints have data to work with:

<CurlTest steps={`
Then the response status should be 200
`}>

```bash
curl -sSfX POST http://localhost:9090/chat/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103 \
  -H "Content-Type: text/plain" \
  -H "Authorization: Bearer $(get-token)" \
  -d "Hello, starting a conversation for sharing tests."
```

</CurlTest>

### List Members

<CurlTest steps={`
Then the response status should be 200
And the response body should be json:
"""
{
  "data": [
    {
      "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
      "userId": "bob",
      "accessLevel": "owner",
      "createdAt": "%{response.body.data[0].createdAt}"
    }
  ]
}
"""
`}>

```bash
# As bob (owner), list members of the conversation
curl -sSfX GET http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103/memberships \
  -H "Authorization: Bearer $(get-token bob bob)" | jq
```

</CurlTest>

### Add a Member

<CurlTest steps={`
Then the response status should be 201
And the response body should be json:
"""
{
  "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
  "userId": "alice",
  "accessLevel": "writer",
  "createdAt": "%{response.body.createdAt}"
}
"""
`}>

```bash
# Share conversation with alice as a writer
curl -sSfX POST http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103/memberships \
  -H "Authorization: Bearer $(get-token bob bob)" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "alice",
    "accessLevel": "writer"
  }' | jq
```

</CurlTest>

Alice can now read and write to the conversation:

<CurlTest steps={`
Then the response status should be 200
`}>

```bash
curl -sSfX POST http://localhost:9090/chat/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103 \
  -H "Authorization: Bearer $(get-token alice alice)" \
  -H "Content-Type: text/plain" \
  -d "Hi from Alice!"
```

</CurlTest>

</TestScenario>

### Update Access Level

```bash
# Promote alice from writer to manager
curl -sSfX PATCH http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103/memberships/alice \
  -H "Authorization: Bearer $(get-token bob bob)" \
  -H "Content-Type: application/json" \
  -d '{
    "accessLevel": "manager"
  }' | jq
```

Example response:

```json
{
  "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
  "userId": "alice",
  "accessLevel": "manager",
  "createdAt": "2025-01-10T14:33:15Z"
}
```

Now alice can share with others (but only assign writer/reader levels):

```bash
curl -sSfX POST http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103/memberships \
  -H "Authorization: Bearer $(get-token alice alice)" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "charlie",
    "accessLevel": "reader"
  }' | jq
```

Example response:

```json
{
  "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
  "userId": "charlie",
  "accessLevel": "reader",
  "createdAt": "2025-01-10T14:34:00Z"
}
```

### Remove a Member

```bash
# Remove charlie from the conversation
curl -sSfX DELETE http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103/memberships/charlie \
  -H "Authorization: Bearer $(get-token bob bob)"
```

Returns `204 No Content` on success. Charlie can no longer access the conversation:

```bash
curl -sSf GET http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103 \
  -H "Authorization: Bearer $(get-token charlie charlie)"
```

Returns `403 Forbidden`.

## Testing Ownership Transfers

### Initiate a Transfer

```bash
# Bob (owner) wants to transfer ownership to alice
curl -sSfX POST http://localhost:9090/v1/ownership-transfers \
  -H "Authorization: Bearer $(get-token bob bob)" \
  -H "Content-Type: application/json" \
  -d '{
    "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
    "newOwnerUserId": "alice"
  }' | jq
```

Example response:

```json
{
  "id": "17c661b1-aa73-4b1d-91d1-f68c180a0b21",
  "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
  "fromUserId": "bob",
  "toUserId": "alice",
  "createdAt": "2025-02-08T10:30:00Z"
}
```

### List Pending Transfers

```bash
# Alice sees transfers where she is the recipient
curl -sSfX GET "http://localhost:9090/v1/ownership-transfers?role=recipient" \
  -H "Authorization: Bearer $(get-token alice alice)" | jq
```

Example response:

```json
{
  "data": [
    {
      "id": "17c661b1-aa73-4b1d-91d1-f68c180a0b21",
      "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
      "fromUserId": "bob",
      "toUserId": "alice",
      "createdAt": "2025-02-08T10:30:00Z"
    }
  ]
}
```

Other role filters:

```bash
# Bob sees transfers where he is the sender
curl -sSfX GET "http://localhost:9090/v1/ownership-transfers?role=sender" \
  -H "Authorization: Bearer $(get-token bob bob)" | jq

# List all (sent or received)
curl -sSfX GET "http://localhost:9090/v1/ownership-transfers?role=all" \
  -H "Authorization: Bearer $(get-token alice alice)" | jq
```

### Accept a Transfer

```bash
# Alice accepts the transfer (use the transfer ID from the create response)
TRANSFER_ID="17c661b1-aa73-4b1d-91d1-f68c180a0b21"
curl -sSfX POST http://localhost:9090/v1/ownership-transfers/$TRANSFER_ID/accept \
  -H "Authorization: Bearer $(get-token alice alice)"
```

Returns `204 No Content` on success. Verify the new membership state:

```bash
curl -sSfX GET http://localhost:9090/v1/conversations/4f65f1b4-d0fb-41ab-b8f9-0aedcc721103/memberships \
  -H "Authorization: Bearer $(get-token alice alice)" | jq
```

Example response:

```json
{
  "data": [
    {
      "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
      "userId": "alice",
      "accessLevel": "owner",
      "createdAt": "2025-01-10T14:33:15Z"
    },
    {
      "conversationId": "4f65f1b4-d0fb-41ab-b8f9-0aedcc721103",
      "userId": "bob",
      "accessLevel": "manager",
      "createdAt": "2025-01-10T14:32:05Z"
    }
  ]
}
```

Alice is now the owner. Bob was automatically demoted to manager.

### Decline/Cancel a Transfer

```bash
# Alice can decline the transfer (or bob can cancel it)
TRANSFER_ID="17c661b1-aa73-4b1d-91d1-f68c180a0b21"
curl -sSfX DELETE http://localhost:9090/v1/ownership-transfers/$TRANSFER_ID \
  -H "Authorization: Bearer $(get-token alice alice)"
```

Returns `204 No Content`. The transfer is deleted and ownership remains unchanged.

## Completed Checkpoint

**Completed code**: View the full implementation at [quarkus/examples/doc-checkpoints/06-sharing](https://github.com/chirino/memory-service/tree/main/quarkus/examples/doc-checkpoints/06-sharing)


