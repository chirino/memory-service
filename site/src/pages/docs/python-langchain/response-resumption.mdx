---
layout: ../../../layouts/DocsLayout.astro
title: Python Response Resumption
description: Streaming responses with resume-check, resume, and cancel endpoints.
---
import CodeFromFile from '../../../components/CodeFromFile.astro';
import TestScenario from '../../../components/TestScenario.astro';
import CurlTest from '../../../components/CurlTest.astro';

This guide covers streaming responses, response resumption, and cancellation so users can reconnect after a disconnect and continue where they left off.

For the protocol and behavior model, see [Response Resumption Concepts](/docs/concepts/response-resumption/).

## Prerequisites

**Starting checkpoint**: This guide starts from [python/examples/langchain/doc-checkpoints/03-with-history](https://github.com/chirino/memory-service/tree/main/python/examples/langchain/doc-checkpoints/03-with-history)

Make sure you've completed:
- [Python Getting Started](/docs/python-langchain/getting-started/) - Minimal agent + memory checkpointer
- [Python Conversation History](/docs/python-langchain/conversation-history/) - History recording and conversation APIs

Also complete **Step 2** in [Python Dev Setup](/docs/python-langchain/dev-setup/) (build local `memory-service-langchain` wheel + `UV_FIND_LINKS`); this is temporary until the package is released.

## Streaming Responses

Checkpoint `05` updates `/chat/{conversation_id}` to stream tokens back to the client.

### New Imports in Checkpoint 05

<CodeFromFile
  file="python/examples/langchain/doc-checkpoints/05-response-resumption/app.py"
  lang="python"
  lines="5-18"
/>

**What changed**: `StreamingResponse` and `JSONResponse` are added from `fastapi.responses`. `MemoryServiceResponseResumer` and `extract_stream_text` are imported from `memory_service_langchain`.

**Why**: Streaming responses require a different FastAPI response type (`StreamingResponse`) to flush tokens to the client as they arrive rather than buffering the full answer. `MemoryServiceResponseResumer` is the in-process buffer that captures each token so a second caller can replay the same stream from the beginning. `extract_stream_text` knows how to unwrap the text payload from a LangGraph stream event tuple, isolating that format detail from the endpoint logic.

### What Changes in `chat(...)`

<CodeFromFile
  file="python/examples/langchain/doc-checkpoints/05-response-resumption/app.py"
  lang="python"
  lines="46-68"
/>

**What changed**: The chat handler switches from `agent.invoke(...)` to `agent.astream(..., stream_mode="messages")`. Each event is passed through `extract_stream_text` to get the raw token string, then yielded by the `live_token_source` async generator. `resumer.stream_from_source(conversation_id, live_token_source())` wraps that generator so tokens are buffered in memory. The endpoint returns a `StreamingResponse` with `media_type="text/plain"` instead of a `PlainTextResponse`.

**Why**: Switching to `astream` with `stream_mode="messages"` delivers each token as it is generated by the model rather than waiting for the full response. Wrapping the generator with `resumer.stream_from_source` means any concurrent caller that hits the `/resume` endpoint gets those same buffered tokens replayed from the start, enabling reconnect after a dropped connection without rerunning the model.

<TestScenario checkpoint="python/examples/langchain/doc-checkpoints/05-response-resumption">

Make sure you define a shell function that can get the bearer token for the bob user:

```bash
function get-token() {
  curl -sSfX POST http://localhost:8081/realms/memory-service/protocol/openid-connect/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=memory-service-client" \
    -d "client_secret=change-me" \
    -d "grant_type=password" \
    -d "username=bob" \
    -d "password=bob" \
    | jq -r '.access_token'
}
```

Start a streaming response:

<CurlTest steps={`
Then the response status should be 200
And the response should match pattern "\\w+"
`}>

```bash
curl -NsSfX POST http://localhost:9090/chat/2946ccfc-cf26-43e1-87fc-f71c944895b1 \
  -H "Content-Type: text/plain" \
  -H "Authorization: Bearer $(get-token)" \
  -d "Write a short story about a cat."
```

</CurlTest>

</TestScenario>

## Response Resumption APIs

Checkpoint `05` also exposes three endpoints backed by `MemoryServiceResponseResumer`:

<CodeFromFile
  file="python/examples/langchain/doc-checkpoints/05-response-resumption/app.py"
  lang="python"
  lines="99-121"
/>

**What changed**: Three new endpoints are added, all backed by the shared `resumer` instance: `POST /v1/conversations/resume-check` accepts a JSON array of conversation IDs and returns which ones currently have an in-progress response; `GET /v1/conversations/{conversation_id}/resume` replays the buffered token stream for a single conversation (or 404 if none is active); `POST /v1/conversations/{conversation_id}/cancel` signals the in-progress generation to stop.

**Why**: These endpoints allow a frontend to poll for active streams before attempting a reconnect and to give users an explicit cancel button. Because `resumer` is a module-level singleton, all three endpoints share the same buffer map, so tokens buffered during a `/chat` call are immediately available via `/resume` without any shared state infrastructure.

<TestScenario checkpoint="python/examples/langchain/doc-checkpoints/05-response-resumption">

Check whether a conversation has an in-progress response:

<CurlTest steps={`
Then the response status should be 200
And the response should contain "["
`}>

```bash
curl -sSfX POST http://localhost:9090/v1/conversations/resume-check \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $(get-token)" \
  -d '["2946ccfc-cf26-43e1-87fc-f71c944895b1"]'
```

</CurlTest>

</TestScenario>

Resume manually from another terminal:

```bash
curl -NsSfX GET http://localhost:9090/v1/conversations/2946ccfc-cf26-43e1-87fc-f71c944895b1/resume \
  -H "Authorization: Bearer $(get-token)"
```

Cancel manually:

```bash
curl -sSfX POST http://localhost:9090/v1/conversations/2946ccfc-cf26-43e1-87fc-f71c944895b1/cancel \
  -H "Authorization: Bearer $(get-token)"
```

## Completed Checkpoint

**Completed code**: View the full implementation at [python/examples/langchain/doc-checkpoints/05-response-resumption](https://github.com/chirino/memory-service/tree/main/python/examples/langchain/doc-checkpoints/05-response-resumption)

## Next Steps

Continue to:
- [Sharing](/docs/python-langchain/sharing/) - Membership and ownership transfer APIs
- [Indexing and Search](/docs/python-langchain/indexing-and-search/) - Indexed content and semantic/full-text search
